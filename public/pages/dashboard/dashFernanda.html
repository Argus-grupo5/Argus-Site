<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../../css/dashboard/dashboard.css">
    <link rel="stylesheet" href="../../css/dashboard/servers.css">
    <link rel="stylesheet" href="../../css/dashboard/dashFernanda.css">
    <link rel="stylesheet" href="../../css/dashboard/popup.css">
    <link rel="stylesheet" href="../../css/style.css">
    <title>Dashboard do Suporte Técnico - Jira</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<div id="id_sair"></div>

<header class="desktopNav" id="navDesktop"></header>

<header class="headerTop">
    <div class="geralInfo">
        <div class="info tooltipInfo">
            <div class="server">
                <img src="../../assets/dashboard/desktop/server.svg" alt="">
            </div>
            <div class="serversMonitoring" id="id_servidores_monitorados"></div>
            <span class="tooltiptextInfo">Servidores em monitoramento</span>
        </div>
        <div class="info">
            <div class="bell">
                <img src="../../assets/dashboard/desktop/bell.svg" alt="">
            </div>
            <div class="risk tooltipInfo" id="id_servidores_em_estado_critico">
                <p id="qtd_critico"></p>
                <span class="tooltiptextInfo">Servidores em atenção</span>
            </div>
            <div class="atention tooltipInfo" id="id_servidores_em_estado_de_alerta">
                <p id="qtd_alerta"></p>
                <span class="tooltiptextInfo">Servidores em alerta</span>
            </div>
        </div>
    </div>
</header>

<!-- KPIs -->
<div class="kpis">
    <div class="card">
        <div class="titulo">Total de Chamados</div>
        <div class="valor" id="totalChamados"></div>
    </div>

    <div class="card">
        <div class="titulo">Chamados Abertos</div>
        <div class="valor" id="chamadosAbertos"></div>
    </div>

    <div class="card">
        <div class="titulo">Chamados Fechados</div>
        <div class="valor" id="chamadosFechados"></div>
    </div>

    <div class="card">
        <div class="titulo">Alta Prioridade</div>
        <div class="valor" id="prioAlta"></div>
    </div>

    <div class="card">
        <div class="titulo">Média Prioridade</div>
        <div class="valor" id="prioMedia"></div>
    </div>

    <div class="card">
        <div class="titulo">Baixa Prioridade</div>
        <div class="valor" id="prioBaixa"></div>
    </div>
</div>

<div class="grafico-container">
    <h2>Distribuição de Chamados por Prioridade</h2>
    <canvas id="graficoJira" height="120"></canvas>
</div>

<div class="tabela_dash">
    <h2>Últimos Chamados</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Título</th>
                <th>Responsável</th>
                <th>Prioridade</th>
                <th>Status</th>
                <th>Data de Criação</th>
                <th>Data de Resolução</th>
            </tr>
        </thead>
        <tbody id="tabelaChamados">
        </tbody>
    </table>
</div>

<script>

    async function carregarDadosJira(params) {
        const email_jira = "luiz.hsouza@sptech.school";
        const token_jira = "ATATT3xFfGF08peCbzHDW7NphdJZSbDE73t0jK9txkqai4zucwrE2PQFfmpkoD-GbPoZKzxrFYk51KYdU4IqErcyxUOpBVTP7-JNY56aOmW2ugAKchMZ_47RFtaj5M6JAGPi64A5aQjbJzsQAe5DauvRlZ-zOHVdVhPiEftcuwCEAQR3EHCafgk=D75C1533";
        const dominio_jira = "https://sptech-team-cppjq4lc.atlassian.net";
        const auth = btoa(`${email_jira}:${token_jira}`);
        try {
            const resp = await fetch("/jira/getResumoJira");
            const dado = await resp.json();
           
        if (!dado.issues) {
            console.error('Nenhum chamado retornado:', dado);
            return; 
        }

            const chamados=[]
            dado.issues.forEach(chamado =>{
                const campo=chamado.fields
                chamados.push({
                    id: chamado.id,
                    titulo: chamado.summary,
                    responsavel: chamado.assignee,
                    prioridade: chamado.priority,
                    status: chamado.status,
                    data_criacao: chamado.created,
                    data_resolucao: chamado.resolutiondate
                    })
            });

            console.log(chamados)

        } catch (error) {
            console.error("Erro ao carregar dados do Jira:", error);
        }
    }

    carregarDadosJira()

    function carregarTabela(chamados = []) {
        const tabela = document.getElementById("tabelaChamados");
        tabela.innerHTML = "";

        chamados.forEach(chamado => {
            tabela.innerHTML += `
                <tr>
                    <td>${chamado.key || "-"}</td>
                    <td>${chamado.summary || "-"}</td>
                    <td>${chamado.status || "-"}</td>
                    <td>${chamado.priority || "-"}</td>
                </tr>
            `;
        });
    }

    function atualizarGrafico(dados) {
        const ctx = document.getElementById("graficoJira");

        if (chart) {
            chart.destroy();
        }

        chart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: ["Alta", "Média", "Baixa"],
                datasets: [{
                    label: "Chamados",
                    data: [
                        dados.prioridades.high,
                        dados.prioridades.medium,
                        dados.prioridades.low
                    ],
                    backgroundColor: ["#FF4C4C", "#FFA500", "#4CAF50"] // cores para melhor visualização
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: true }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    carregarDadosJira();
    setInterval(carregarDadosJira, 30000);
</script>

</body>
</html>
