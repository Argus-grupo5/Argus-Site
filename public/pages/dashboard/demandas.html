<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../css/dashboard/popup.css">
    <link rel="stylesheet" href="../../css/cssDashEduardo/style.css">
    <script src="script/dash.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <title>ARGUS | Dashboard</title>
</head>

<body>
    <div id="id_sair">
    </div>

    <header class="desktopNav" id="navDesktop"></header>
    <div class="container">
        <div>
            <H1>Resumo diário</H1>
            <div class="headerSub">
                <p>Visão geral - Lançamentos e demandas</p>
                <p>Última atualização: <span id="attAtual"></span> atrás</p>
            </div>
        </div>
        <div class="resumo">
            <!-- <div class="resumoSituacao">
                <p><span>[ALERTA: RISCO ALTO] HOJE: XXXXX + LANÇAMENTOS DE JOGOS </span></p>
            </div> -->
            <div class="resumoKPIs">
                <div class="resumoCardKPI">
                    <div class="resumoCard">
                        <p class="resumoCardText1">Variação de Demanda (vs. ontem)</p>
                        <p class="resumoCardText"><span id="variacao" class="span"></span> %</p>
                        <div class="infoIcon tooltipInfo">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                                <path fill="currentColor"
                                    d="M11 17h2v-6h-2zm1-8q.425 0 .713-.288T13 8t-.288-.712T12 7t-.712.288T11 8t.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137T2.788 15.9T2 12t.788-3.9t2.137-3.175T8.1 2.788T12 2t3.9.788t3.175 2.137T21.213 8.1T22 12t-.788 3.9t-2.137 3.175t-3.175 2.138T12 22" />
                            </svg>
                            <span class="caixaDemanda">
                                <b>Legenda:</b><br>
                                <span class="legenda azul"></span> Redução de demanda<br>
                                <span class="legenda cinza"></span> Permanência de demanda<br>
                                <span class="legenda verde"></span> Aumento de demanda<br>
                            </span>
                        </div>
                    </div>
                    <div class="resumoCard">
                        <p class="resumoCardText1">Ocupação da Plataforma</p>
                        <p class="resumoCardText"><span id="capacidadePerc" class="span"></span> %</p>
                        <div class="infoIcon infoLegenda">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                                <path fill="currentColor"
                                    d="M11 17h2v-6h-2zm1-8q.425 0 .713-.288T13 8t-.288-.712T12 7t-.712.288T11 8t.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137T2.788 15.9T2 12t.788-3.9t2.137-3.175T8.1 2.788T12 2t3.9.788t3.175 2.137T21.213 8.1T22 12t-.788 3.9t-2.137 3.175t-3.175 2.138T12 22" />
                            </svg>
                            <span class="caixaDemanda">
                                <b>Legenda:</b><br>
                                <span class="legenda verde"></span> Baixa ocupação<br>
                                <span class="legenda amarelo"></span> Ocupação moderada<br>
                                <span class="legenda vermelho"></span> Acima da capacidade<br>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="resumoCardHour">
                    <p>Demanda prevista</p>
                    <p class="titleHour" id="titleHour">XX:XXh - XX:XXh</p>
                    <div class="ccuHour">
                        <p><span id="titleCCU"></span> CCU</p>
                        <div class="infoIcon infoLegenda">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                                <path fill="currentColor"
                                    d="M11 17h2v-6h-2zm1-8q.425 0 .713-.288T13 8t-.288-.712T12 7t-.712.288T11 8t.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137T2.788 15.9T2 12t.788-3.9t2.137-3.175T8.1 2.788T12 2t3.9.788t3.175 2.137T21.213 8.1T22 12t-.788 3.9t-2.137 3.175t-3.175 2.138T12 22" />
                            </svg>
                            <span class="caixaDemanda">
                                <b>Legenda:</b><br>
                                <span></span> CCU: Concurrent Users<br>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="graficos">
            <div id="chart"></div>
            <div class="graficosDown">
                <div id="chart2"></div>
                <div class="kpi-container-vertical">
                    <div class="kpi-card-vertical">
                        <span class="kpi-title">Pico Semanal de CCU real</span>
                        <p><span class="kpi-value" id="kpi-semanal"></span>CCU</p>
                    </div>
                    <div class="kpi-card-vertical">
                        <span class="kpi-title">Pico Semanal de GPU</span>
                        <p><span class="kpi-value" id="kpi-gpu"></span>%</p>
                    </div>
                    <div class="kpi-card-vertical">
                        <span class="kpi-title">Diferença Previsto x Real</span>
                        <p id="kpi-phrase"><span class="kpi-value" id="kpi-ccu"></span>%</p>
                        <p id="kpi-phrase2" class="kpi-phrase">(<span class="kpi-value kpi-phrase"
                                id="kpi-ccu-num"></span>CCU)</p>
                        <div class="infoIcon tooltipInfo">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                                <path fill="currentColor"
                                    d="M11 17h2v-6h-2zm1-8q.425 0 .713-.288T13 8t-.288-.712T12 7t-.712.288T11 8t.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137T2.788 15.9T2 12t.788-3.9t2.137-3.175T8.1 2.788T12 2t3.9.788t3.175 2.137T21.213 8.1T22 12t-.788 3.9t-2.137 3.175t-3.175 2.138T12 22" />
                            </svg>
                            <span class="caixaDemanda">
                                <b>Legenda:</b><br>
                                <span class="legenda azul"></span> Diferença > 10%<br>
                                <span class="legenda verde"></span> Diferença < 10%<br>
                            </span>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <div class="listsContainer">
            <div class="listOutside">
                <div class="listHeader">
                    <p>Próximos lançamentos</p>
                    <select name="" id="selectLanc" onchange="selectLanc()">
                        <option value="1" id="" selected>Diário</option>
                        <option value="2" id="">Semanal</option>
                        <option value="3" id="">Mensal</option>
                    </select>
                </div>
                <div class="listInside">
                    <div class="listGridHeader">
                        <div>Foto</div>
                        <div>Nome</div>
                        <div>Pontuação</div>
                        <div>CCU Previsto</div>
                    </div>
                    <div class="listItem" id="listLanc">
                        <p style="text-align: center;">Sem lançamentos</p>
                    </div>
                </div>
            </div>
            <div class="listOutside">
                <div class="listHeader">
                    <p>Jogos mais jogados</p>
                    <p>Hoje</p>
                </div>
                <div class="listInside">
                    <div class="listGridHeader_one">
                        <div>Foto</div>
                        <div>Nome</div>
                        <div>CCU Previsto</div>
                    </div>
                    <div class="listItem" id="top10">
                        <div class="card_one">
                            <div class="listFoto"></div>
                            <div class="listNome">XXXX</div>
                            <div class="listCCU">ZZZZZZ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>


<script>
    header("dashboard", sessionStorage.CARGO_CARGO);


    var data = [];
    var dataReal = [];
    var dias = [];
    var mediaGpu = [];
    var utilizacaoPerc = [];
    var capacidade;
    var lancamentosDiarios = [];
    var lancamentosSemanais = [];
    var lancamentosMensais = [];

    var ccuDic = {
        ccuPrev: data,
        ccuReal: dataReal
    }

    function formatarHoje() {
        var diaDeHoje = new Date();
        var ano = diaDeHoje.getFullYear();
        var mes = diaDeHoje.getMonth() + 1;
        var dia = diaDeHoje.getDate();

        var dataFormatada = `${ano}-${mes}-${dia}`
        return dataFormatada;
    }
    function formatarSemana() {
        var diaDeHoje = new Date();
        var ano = diaDeHoje.getFullYear();
        var mes = diaDeHoje.getMonth() + 1;
        var dia = diaDeHoje.getDate() + 7;
        var diaSemana = diaDeHoje.getDay()

        var dataFormatada = `${ano}-${mes}-${dia}`
        return dataFormatada;
    }
    function formatarInicioSemana() {
        var diaDeHoje = new Date();
        var ano = diaDeHoje.getFullYear();
        var mes = diaDeHoje.getMonth() + 1;
        var diaSemana = diaDeHoje.getDay()
        var dia = diaDeHoje.getDate() - diaSemana;

        var dataFormatada = `${ano}-${mes}-${dia}`
        return dataFormatada;
    }
    var diaDeHoje = formatarHoje();

    function buscarHorario(chave) {
        fetch(`/s3Route/dados/${chave}`, {
            method: "GET",
            headers: {
                'Content-Type': 'application/json'
            }
        }).then((content) => {
            content.json().then((json) => {
                document.getElementById("titleHour").innerHTML = json.HorarioPico
            })
        })
    }


    function buscarCCU(chave) {
        fetch(`/s3Route/dados/${chave}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        }).then((content) => {
            content.json().then((json) => {
                var ccu = json[json.length - 1].CCU
                document.getElementById("titleCCU").innerHTML = Number(ccu).toFixed();

                capacidade = json[json.length - 1].capacidadeTotal
                var percCap = (ccu * 100) / capacidade
                if (percCap > 100) {
                    percCap = 100
                    document.getElementById("capacidadePerc").classList.add("vermelho")
                } else if (percCap >= 85) {
                    document.getElementById("capacidadePerc").classList.add("vermelho")
                } else if (percCap >= 65) {
                    document.getElementById("capacidadePerc").classList.add("amarelo")
                } else {
                    document.getElementById("capacidadePerc").classList.add("verde")
                }
                document.getElementById("capacidadePerc").innerHTML = percCap.toFixed(2)
                buscarDados(json)
                plotarGrafico();
                document.getElementById("variacao").innerHTML = calcularVariacao(data)

                if (calcularVariacao(data) > 0) {
                    document.getElementById("variacao").classList.add("vermelho")
                } else if (calcularVariacao(data) == 0) {
                    document.getElementById("variacao").classList.add("cinza")
                } else {
                    document.getElementById("variacao").classList.add("azul")
                }

                document.getElementById("kpi-semanal").innerHTML = buscarUmaSemana(json)

                ccuXreal();
            })
        })
    }

    function buscarLancamentos(chave, diaAtual) {
        var listLanc = document.getElementById("listLanc")

        fetch(`/s3Route/dados/${chave}`, {
            method: "GET",
            headers: {
                'Content-Type': 'application/json'
            }
        }).then((content) => {
            content.json().then((json) => {
                if (json.jogosLancados.length > 0) {
                    listLanc.innerHTML = "";
                }
                json.jogosLancados.forEach(jogos => {
                    dataJogo = `${jogos.released[0]}-${jogos.released[1]}-${jogos.released[2]}`
                    if (dataJogo == formatarHoje()) {
                        lancamentosDiarios.push(jogos)
                    }
                    if (dataJogo >= formatarInicioSemana() && dataJogo <= formatarSemana()) {
                        lancamentosSemanais.push(jogos)
                    }
                    lancamentosMensais.push(jogos)
                })
                const valor = document.getElementById("selectLanc").value;
                plotarJogos(valor)
            })
        })
    }

    function buscarTop10(chave, diaAtual) {
        var top10 = document.getElementById("top10")
        fetch(`/s3Route/dados/${chave}`, {
            method: "GET",
            headers: {
                'Content-Type': 'application/json'
            }
        }).then((content) => {
            content.json().then((json) => {
                if (json.jogosSteam.length > 0) {
                    top10.innerHTML = "";
                }
                json.jogosSteam.forEach(jogos => {
                    top10.innerHTML += `<div class="card_one">
                                    <div class="bgLayer" style="background-image: url(${jogos.image})"></div>
                                    <div class="blurLayer"></div>
                                    <div class="listFoto_One"> <img src="${jogos.image}"></img></div>
                                    <div class="listNome">${jogos.name}</div>
                                    <div class="listCCU">${jogos.peak_in_game}</div>
                                </div>`
                })
            })
        })
    }

    function buscarMediaCpu(chave) {
        fetch(`/s3Route/dados/${chave}`, {
            method: "GET",
            headers: {
                'Content-Type': 'application/json'
            }
        }).then((content) => {
            content.json().then((json) => {
                buscarDados(json)
                plotarGrafico2();
                buscarUmaSemanaGpu()

            })
        })
    }

    function buscarDados(json) {
        for (let i = 0; i < json.length; i++) {
            if (json[i].CCU != undefined) {
                data.push(json[i].CCU)
                var percCap = (Number(json[i].CCUReal) * 100) / capacidade
                if (percCap > 100) {
                    percCap = 100
                }
                utilizacaoPerc.push(percCap.toFixed(2))
                if (json[i].CCUReal == "null") {
                    continue;
                } else {
                    dataReal.push(json[i].CCUReal)
                }
                dias.push(json[i].dataAtual)
            } else if (json[i].mediaGPU != undefined) {
                mediaGpu.push(Number(json[i].mediaGPU).toFixed(2))
            }
        }
    }

    function calcularVariacao(data) {
        var demanda = ((data[data.length - 1] - data[data.length - 2]) /
            data[data.length - 2]) * 100
        return demanda.toFixed(2)
    }

    var empresa = sessionStorage.EMPRESA_NOME_FANTASIA;
    empresa = empresa.replace(" ", "%20")

    var lancKey = `infra/${empresa}/lancamentos/${new Date().getFullYear()}/lancamentos_${new Date().getMonth() + 1}.json`
    var steamKey = `infra/${empresa}/jogos/steam_${diaDeHoje}.json`
    var diaKey = `infoDia/data_${diaDeHoje}.json`
    var ccuKey = `infra/${empresa}/ccu.csv`
    var cpuKey = `infra/${empresa}/mediaCpu.csv`
    buscarHorario(diaKey);
    buscarLancamentos(lancKey, diaDeHoje);
    buscarTop10(steamKey, diaDeHoje);
    buscarCCU(ccuKey)
    buscarMediaCpu(cpuKey)

    function plotarGrafico() {
        var data7 = data.slice(-7);
        var dataReal7 = dataReal.slice(-7);
        var dias7 = dias.slice(-7);

        var options = {
            series: [
                {
                    name: "CCU Previsto",
                    data: data7
                },
                {
                    name: "CCU Real",
                    data: dataReal7
                }
            ],
            colors: ['#FF670A', '#FFD166'],
            stroke: {
                width: 3,
                curve: 'smooth',
                dashArray: [5, 0]
            },
            chart: {
                height: 350,
                width: '100%',
                type: 'line',
                background: '#2b2b2b',
                zoom: { enabled: false }
            },

            annotations: {
                yaxis: [
                    {
                        y: capacidade,
                        borderColor: '#ff0000',
                        label: {
                            text: 'Capacidade Máxima',
                            style: {
                                background: '#ff0000',
                                color: '#fff'
                            }
                        }
                    }
                ],
                shapes: [
                    {
                        type: 'rect',
                        x: 0,
                        y: capacidade,
                        x2: dias7.length - 1,
                        y2: capacidade * 1.15,
                        fillColor: 'rgba(255, 0, 0, 0.12)',
                    }
                ]
            },

            dataLabels: { enabled: false },

            title: {
                text: 'Demanda prevista X Demanda real',
                align: 'left',
                style: { color: '#FF670A' }
            },

            grid: {
                borderColor: "#4b4b4b",
                row: {
                    colors: ['#3b3b3b', 'transparent'],
                    opacity: 0.3
                }
            },

            xaxis: {
                categories: dias7,
                labels: { style: { colors: '#bdc3c7' } }
            },

            yaxis: {
                labels: { style: { colors: '#bdc3c7' } }
            },

            markers: {
                size: 5,
                colors: ['#FF670A', '#FFD166'],
                strokeColors: ['#000000', '#000000'],
                strokeWidth: 2
            },

            tooltip: {
                theme: 'dark',
                style: {
                    fontSize: '14px',
                    color: '#f39c12'
                },
                marker: {
                    fillColors: ['#FF670A', '#FFD166']
                }
            },

            legend: {
                show: true,
                position: 'bottom',
                horizontalAlign: 'center',
                labels: {
                    colors: ['#FF670A', '#fff'],
                    useSeriesColors: false
                },
                markers: {
                    width: 12,
                    height: 12,
                    strokeWidth: 2,
                    strokeColor: '#000',
                    fillColors: ['#FF670A', '#FFD166']
                }
            }
        };

        var chart = new ApexCharts(document.querySelector("#chart"), options);
        chart.render();
    }


    function plotarGrafico2() {
        var options = {
            series: [
                {
                    name: "Média de GPU",
                    data: mediaGpu,
                },
                {
                    name: "Ocupação da plataforma",
                    data: utilizacaoPerc,
                }
            ],
            colors: ['#FF670A', '#FFD166'],
            chart: {
                height: 350,
                width: 520,
                type: 'bar',
                background: '#2b2b2b',
                zoom: { enabled: false }
            },
            plotOptions: {
                bar: {
                    horizontal: false,
                    borderRadius: 4,
                    columnWidth: '50%',
                }
            },
            dataLabels: {
                enabled: false
            },
            title: {
                text: 'Média de GPU X Ocupação da plataforma',
                align: 'left',
                style: {
                    color: '#FF670A'
                }
            },
            grid: {
                borderColor: "#4b4b4b",
                row: {
                    colors: ['#3b3b3b', 'transparent'],
                    opacity: 0.3
                }
            },
            xaxis: {
                categories: dias,
                labels: {
                    style: { colors: '#bdc3c7' }
                }
            },
            yaxis: {
                labels: {
                    style: { colors: '#bdc3c7' }
                }
            },
            tooltip: {
                theme: 'dark',
                style: {
                    fontSize: '14px',
                    color: '#f39c12'
                },
                marker: {
                    fillColors: ['#FF670A', '#FFD166']
                }
            },
            legend: {
                show: true,
                position: 'bottom',
                horizontalAlign: 'center',
                labels: {
                    colors: ['#FF670A', '#fff'],
                    useSeriesColors: false
                },
                markers: {
                    width: 12,
                    height: 12,
                    strokeWidth: 2,
                    strokeColor: '#000',
                    fillColors: ['#FF670A', '#FFD166']
                }
            }
        };

        var chart = new ApexCharts(document.querySelector("#chart2"), options);
        chart.render();
    }

    function buscarUmaSemana(json) {
        let diaAtual = new Date()
        let umaSemana = new Date(diaAtual.getTime() - 7 * 24 * 60 * 60 * 1000);
        let ccuReaisSemanal = []
        json.forEach((dados) => {
            const data = new Date(dados.dataAtual);
            const valor = Number(dados.CCUReal);
            if (data >= umaSemana && data <= diaAtual) {
                ccuReaisSemanal.push(valor)
            }
        })
        let pico = 0;
        ccuReaisSemanal.forEach((valor) => {
            if (!isNaN(valor) && valor > pico) {
                pico = valor
            }
        })
        return pico;
    }

    function buscarUmaSemanaGpu() {
        let gpuSemanal = []
        let j = mediaGpu.length - 1
        for (let i = 0; i < 7; i++) {
            if (j < 0) break;
            gpuSemanal.push(mediaGpu[j])
            j--
        }
        let pico = 0;
        gpuSemanal.forEach((valor) => {
            if (!isNaN(valor) && valor > pico) {
                pico = valor
            }
        })
        document.getElementById("kpi-gpu").innerHTML = pico
    }

    function ccuXreal() {
        let ontemIndex = ccuDic.ccuPrev.length - 2;
        if (ontemIndex < 0) return;

        let ccuPrev = ccuDic.ccuPrev[ontemIndex];
        let ccuReal = ccuDic.ccuReal[ontemIndex];

        let diferenca = 0;
        if (!isNaN(ccuPrev) && !isNaN(ccuReal)) {
            diferenca = ((ccuReal - ccuPrev) / ccuPrev * 100).toFixed(2)
            diferencaJ = ccuReal - ccuPrev
        }
        console.log(diferenca)
        document.getElementById("kpi-ccu").innerHTML = diferenca;
        document.getElementById("kpi-ccu-num").innerHTML = diferencaJ;

        if (diferenca > 15 || diferenca < -15) {
            document.getElementById("kpi-ccu").classList.add("vermelho")
            document.getElementById("kpi-phrase").classList.add("vermelho")
            document.getElementById("kpi-phrase2").classList.add("vermelho")
            document.getElementById("kpi-ccu-num").classList.add("vermelho")
        } else {
            document.getElementById("kpi-ccu").classList.add("verde")
            document.getElementById("kpi-phrase").classList.add("verde")
            document.getElementById("kpi-phrase2").classList.add("verde")
            document.getElementById("kpi-ccu-num").classList.add("verde")
        }
    }

    function tempoAtt() {
        let dataHora = new Date()
        let attAtual = (dataHora.getHours() - 6 + 24) % 24
        let attMin = dataHora.getMinutes()
        document.getElementById("attAtual").innerHTML = `${attAtual}h ${attMin}min`
    }

    function selectLanc() {
        const valor = document.getElementById("selectLanc").value;
        plotarJogos(valor)
    }

    function plotarJogos(valor) {
        valor = Number(valor)
        var listLanc = document.getElementById("listLanc")

        listLanc.innerHTML = ""

        if (valor == 1) {
            lancamentosDiarios.forEach((jogos) => {
                console.log(jogos)
                listLanc.innerHTML += `<div class="card">
                             <div class="bgLayer" style="background-image: url(${jogos.background_image})"></div>
                                        <div class="blurLayer"></div>
                                        <div class="listFoto"><img src="${jogos.background_image}"></img></div>
                                        <div class="listNome">${jogos.name}</div>
                                        <div class="listNome">${jogos.pontuacao.toFixed(2)}</div>
                                        <div class="listCCU">${jogos.ccu}</div>
                                    </div>`
            })
        } else if (valor == 2) {
            lancamentosSemanais.forEach((jogos) => {
                listLanc.innerHTML += `<div class="card">
                             <div class="bgLayer" style="background-image: url(${jogos.background_image})"></div>
                                        <div class="blurLayer"></div>
                                        <div class="listFoto"><img src="${jogos.background_image}"></img></div>
                                        <div class="listNome">${jogos.name}</div>
                                        <div class="listNome">${jogos.pontuacao.toFixed(2)}</div>
                                        <div class="listCCU">${jogos.ccu}</div>
                                    </div>`
            })
        } else {
            lancamentosMensais.forEach((jogos) => {
                listLanc.innerHTML += `<div class="card">
                             <div class="bgLayer" style="background-image: url(${jogos.background_image})"></div>
                                        <div class="blurLayer"></div>
                                        <div class="listFoto"><img src="${jogos.background_image}"></img></div>
                                        <div class="listNome">${jogos.name}</div>
                                        <div class="listNome">${jogos.pontuacao.toFixed(2)}</div>
                                        <div class="listCCU">${jogos.ccu}</div>
                                    </div>`
            })
        }
    }


    tempoAtt()
    setTimeout(tempoAtt, 60000)

</script>