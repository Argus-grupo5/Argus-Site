<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../../css/dashboard/server-overview.css">
    <link rel="stylesheet" href="../../css/dashboard/dashFellipe.css">
    <link rel="stylesheet" href="../../css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>VisÃ£o Geral - Servidor</title>
</head>

<body>

    <nav class="desktopNav" aria-label="Sidebar">
        <div class="logo">
            <img src="../../assets/icon/logoMobileBlack.svg" alt="ARGUS Logo">
        </div>

        <div class="footerButtons">
            <button class="navButton logout-btn tooltipNav" data-label="Sair">
                <img src="../../assets/dashboard/desktop/logout.svg" alt="Sair">
                <span class="tooltiptextNav">Sair</span>
            </button>
        </div>
    </nav>

    <div id="alerts-filter-modal" class="modal-filter">
        <div class="modal-content-filter">
            <span class="close-btn-filter">&times;</span>
            <h3>Filtrar Alertas</h3>

            <div class="filter-group">
                <h4>MÃªs</h4>
                <div class="filter-options" id="month-options">
                    <button class="filter-option" data-filter="month" data-value="01">Jan</button>
                    <button class="filter-option" data-filter="month" data-value="02">Fev</button>
                    <button class="filter-option" data-filter="month" data-value="03">Mar</button>
                    <button class="filter-option" data-filter="month" data-value="04">Abr</button>
                    <button class="filter-option" data-filter="month" data-value="05">Mai</button>
                    <button class="filter-option" data-filter="month" data-value="06">Jun</button>
                    <button class="filter-option" data-filter="month" data-value="07">Jul</button>
                    <button class="filter-option" data-filter="month" data-value="08">Ago</button>
                    <button class="filter-option" data-filter="month" data-value="09">Set</button>
                    <button class="filter-option" data-filter="month" data-value="10">Out</button>
                    <button class="filter-option" data-filter="month" data-value="11">Nov</button>
                    <button class="filter-option" data-filter="month" data-value="12">Dez</button>
                </div>
            </div>

            <div class="filter-group">
                <h4>Componente de Hardware</h4>
                <div class="filter-options" id="component-options">
                    <button class="filter-option" data-filter="component" data-value="CPU">CPU</button>
                    <button class="filter-option" data-filter="component" data-value="RAM">RAM</button>
                    <button class="filter-option" data-filter="component" data-value="DISCO">DISCO</button>
                    <button class="filter-option" data-filter="component" data-value="GPU">GPU</button>
                </div>
            </div>

            <div class="modal-actions">
                <button id="apply-filters-btn" class="action-btn primary">Aplicar Filtros</button>
                <button id="clear-filters-btn" class="action-btn secondary">Limpar Filtros</button>
            </div>
        </div>
    </div>


    <div class="main-content">
        <header class="desktopNavHeader" id="navDesktop"></header>

        <div class="server-overview-container">
            <div class="overview-header">
                <h2>VisÃ£o Geral - Servidor </h2>
            </div>

            <div class="region-filter-bar">
                <select id="regionSelect">
                    <option value="">Selecione a regiÃ£o...</option>
                    <option value="sp">SP</option>
                    <option value="rj">RJ</option>
                    <option value="pe">PE</option>
                    <option value="rs">RS</option>
                    <option value="pa">PA</option>
                    <option value="mg">MG</option>
                    <option value="ba">BA</option>
                    <option value="am">AM</option>
                </select>

                <button id="applyRegionFilter">Filtrar RegiÃ£o</button>
            </div>

            <div class="metrics-cards">
                <div class="metric-card cpu-card">
                    <div class="metric-tooltip"> LEGENDA:<br>
                        0% - 70% ðŸŸ©<br>
                        71% - 80% ðŸŸ¨<br>
                        81% - 100% ðŸŸ¥</div>

                    <div class="metric-label">CPU em Uso</div>
                    <div class="metric-info">No Ãºltimo dia (24h)</div>
                    <div class="metric-value">43%</div>
                    <div class="metric-info">4 de 12 cores em uso</div>
                </div>

                <div class="metric-card memory-card">
                    <div class="metric-tooltip">LEGENDA:<br>
                        0% - 65% ðŸŸ©<br>
                        66% - 75% ðŸŸ¨<br>
                        76% - 100% ðŸŸ¥</div>

                    <div class="metric-label">MEMÃ“RIA em Uso</div>
                    <div class="metric-info">No Ãºltimo dia (24h)</div>
                    <div class="metric-value">78%</div>
                    <div class="metric-info">81.3GB de 1.3GB em uso</div>
                </div>

                <div class="metric-card gpu-card">
                    <div class="metric-tooltip">LEGENDA:<br>
                        0% - 90% ðŸŸ©<br>
                        91% - 95% ðŸŸ¨<br>
                        96% - 100% ðŸŸ¥</div>

                    <div class="metric-label">GPU em Uso</div>
                    <div class="metric-info">No Ãºltimo dia (24h)</div>
                    <div class="metric-value">78%</div>
                    <div class="metric-info">81.3GB de 1.3GB em uso</div>
                </div>

                <div class="metric-card storage-card">
                    <div class="metric-tooltip">LEGENDA:<br>
                        0% - 80% ðŸŸ©<br>
                        81% - 85% ðŸŸ¨<br>
                        86% - 100% ðŸŸ¥</div>
                    <div class="metric-label">DISCO em Uso</div>
                    <div class="metric-info">No Ãºltimo dia (24h)</div>
                    <div class="metric-value">78%</div>
                    <div class="metric-info">81.3GB de 1.3GB em uso</div>
                </div>

                <div class="metric-card latency-card">
                    <div class="metric-tooltip">LEGENDA:<br>
                        0ms - 10ms ðŸŸ©<br>
                        11ms - 20ms ðŸŸ¨<br>
                        21ms - 1000ms ðŸŸ¥</div>

                    <div class="metric-label">LATÃŠNCIA em Uso</div>
                    <div class="metric-info">No Ãºltimo dia (24h)</div>
                    <div class="metric-value">78%</div>
                    <div class="metric-info">81.3GB de 1.3GB em uso</div>
                </div>
            </div>

            <div class="charts-section">
                <div class="chart-container">
                    <h4>CPU x GPU</h4>
                    <canvas id="cpuRamChart"></canvas>
                </div>
                <div class="chart-container">
                    <h4>DISCO X RAM</h4>
                    <canvas id="diskChart"></canvas>
                </div>
            </div>

            <!-- <div class="alerts-section">
                <div class="alerts-header-with-filter">
                    <span id="filter-status">Filtro: **Todos**</span>
                    <h3>Alertas e Logs</h3>
                    <button id="filter-alerts-btn" class="action-btn secondary filter-btn-trigger">
                        Filtrar
                    </button>
                </div>
                <div class="alerts-list">
                    <div class="alert-item">
                        <span class="alert-type">CPU | Grave</span>
                        <span class="alert-time">12/10 - 17:00 | 13/10 - 17:00</span>
                    </div>
                    <div class="alert-item">
                        <span class="alert-type">RAM | Grave</span>
                        <span class="alert-time">12/10 - 17:00 | 13/10 - 17:00</span>
                    </div>
                    <div class="alert-item">
                        <span class="alert-type">DISCO | Grave</span>
                        <span class="alert-time">12/10 - 17:00 | 13/10 - 17:00</span>
                    </div>
                </div>
            </div> -->
        </div>
    </div>

    <script src="../../js/server-overview.js"></script>
    <script>
        let dadosOriginais = [];

        function atualizarDashboard(dados) {
            const n = (arr, key) => arr.map(i => parseFloat(i[key])).filter(x => !isNaN(x));
            const set = (sel, val) => { const el = document.querySelector(sel); if (el) el.textContent = val; };

            set(".cpu-card .metric-value", (n(dados, "cpu").reduce((a, b) => a + b) / dados.length).toFixed(1) + "%");
            set(".memory-card .metric-value", (n(dados, "ram").reduce((a, b) => a + b) / dados.length).toFixed(1) + "%");
            set(".gpu-card .metric-value", (n(dados, "uso % GPU").reduce((a, b) => a + b) / dados.length).toFixed(1) + "%");
            set(".storage-card .metric-value", (n(dados, "disco").reduce((a, b) => a + b) / dados.length).toFixed(1) + "%");
            set(".latency-card .metric-value", (n(dados, "rede (ms)").reduce((a, b) => a + b) / dados.length).toFixed(1) + " ms");

            const faixas = agruparPorFaixaHoraria(dados);
            const labels = Object.keys(faixas);

            cpuRamChart.data.labels = labels;
            cpuRamChart.data.datasets[0].data = labels.map(f => faixas[f].cpu);
            cpuRamChart.data.datasets[1].data = labels.map(f => faixas[f].gpu);
            cpuRamChart.update();

            diskChart.data.labels = labels;
            diskChart.data.datasets[0].data = labels.map(f => faixas[f].disco);
            diskChart.data.datasets[1].data = labels.map(f => faixas[f].ram);
            diskChart.update();
        }

        document.getElementById("applyRegionFilter").addEventListener("click", () => {
            const regiao = document.getElementById("regionSelect").value;
            if (!regiao) {
                alert("Selecione uma regiÃ£o!");
                return;
            }

            const filtrados = dadosOriginais.filter(item => {
                const valorRegiao = item.usuario.slice(-2).toLowerCase();
                return valorRegiao === regiao;
            });

            if (filtrados.length === 0) { alert("Nenhum dado encontrado."); return; }

            atualizarDashboard(filtrados);
        });
    </script>
</body>

</html>

<script>

    function agruparPorFaixaHoraria(data) {
        const faixas = {
            "00:00": { cpu: 0, gpu: 0, disco: 0, ram: 0, count: 0 },
            "06:00": { cpu: 0, gpu: 0, disco: 0, ram: 0, count: 0 },
            "12:00": { cpu: 0, gpu: 0, disco: 0, ram: 0, count: 0 },
            "18:00": { cpu: 0, gpu: 0, disco: 0, ram: 0, count: 0 }
        };

        data.forEach(item => {
            const hora = new Date(item.timestamp).getHours();

            let faixa = "";
            if (hora < 6) faixa = "00:00";
            else if (hora < 12) faixa = "06:00";
            else if (hora < 18) faixa = "12:00";
            else if (hora < 23) faixa = "18:00";

            faixas[faixa].cpu += parseFloat(item.cpu) || 0;
            faixas[faixa].gpu += parseFloat(item["uso % GPU"]) || 0;
            faixas[faixa].disco += parseFloat(item.disco) || 0;
            faixas[faixa].ram += parseFloat(item.ram) || 0;
            faixas[faixa].count++;
        });

        // calcular mÃ©dias
        Object.keys(faixas).forEach(faixa => {
            if (faixas[faixa].count > 0) {
                faixas[faixa].cpu /= faixas[faixa].count;
                faixas[faixa].gpu /= faixas[faixa].count;
                faixas[faixa].disco /= faixas[faixa].count;
                faixas[faixa].ram /= faixas[faixa].count;
            }
        });

        return faixas;
    }

    function aplicarCor(elemento, valor, ranges) {
        elemento.classList.remove("green", "yellow", "red");

        if (valor >= ranges.red.min && valor <= ranges.red.max) {
            elemento.classList.add("red");
        } else if (valor >= ranges.yellow.min && valor <= ranges.yellow.max) {
            elemento.classList.add("yellow");
        } else {
            elemento.classList.add("green");
        }
    }

    fetch("https://bucket-client-f.s3.amazonaws.com/dados-client.json")
        .then(response => response.json())
        .then(data => {

            const valorNumerico = (array, key) =>
                array
                    .map(item => parseFloat(item[key]))
                    .filter(v => !isNaN(v));

            const valorCpu = valorNumerico(data, "cpu");
            const mediaCpu = valorCpu.reduce((a, b) => a + b, 0) / valorCpu.length;

            const cpuEl = document.querySelector(".cpu-card .metric-value");
            cpuEl.textContent = mediaCpu.toFixed(1) + "%";

            aplicarCor(cpuEl, mediaCpu, {
                green: { min: 0, max: 70 },
                yellow: { min: 71, max: 80 },
                red: { min: 81, max: 100 }
            });

            const valorRam = valorNumerico(data, "ram");
            const mediaRam = valorRam.reduce((a, b) => a + b, 0) / valorRam.length;

            const ramEl = document.querySelector(".memory-card .metric-value");
            ramEl.textContent = mediaRam.toFixed(1) + "%";

            aplicarCor(ramEl, mediaRam, {
                green: { min: 0, max: 65 },
                yellow: { min: 66, max: 75 },
                red: { min: 76, max: 100 }
            });

            const valorDisco = valorNumerico(data, "disco");
            const mediaDisco = valorDisco.reduce((a, b) => a + b, 0) / valorDisco.length;

            const discoEl = document.querySelector(".storage-card .metric-value");
            discoEl.textContent = mediaDisco.toFixed(1) + "%";

            aplicarCor(discoEl, mediaDisco, {
                green: { min: 0, max: 80 },
                yellow: { min: 81, max: 85 },
                red: { min: 86, max: 100 }
            });

            const valorGpu = valorNumerico(data, "uso % GPU");
            const mediaGpu = valorGpu.reduce((a, b) => a + b, 0) / valorGpu.length;

            const gpuEl = document.querySelector(".gpu-card .metric-value");
            gpuEl.textContent = mediaGpu.toFixed(1) + "%";

            aplicarCor(gpuEl, mediaGpu, {
                green: { min: 0, max: 90 },
                yellow: { min: 91, max: 95 },
                red: { min: 96, max: 100 }
            });

            const valorLatencia = valorNumerico(data, "rede (ms)");
            const latenciaMedia = valorLatencia.reduce((a, b) => a + b, 0) / valorLatencia.length;

            const redeEl = document.querySelector(".latency-card .metric-value");
            redeEl.textContent = latenciaMedia.toFixed(1) + " ms";

            aplicarCor(redeEl, latenciaMedia, {
                green: { min: 0, max: 10 },
                yellow: { min: 11, max: 19 },
                red: { min: 20, max: 9999 }
            });

            const faixas = agruparPorFaixaHoraria(data);

            const labels = Object.keys(faixas);

            const cpuFaixa = labels.map(f => faixas[f].cpu);
            const gpuFaixa = labels.map(f => faixas[f].gpu);
            const discoFaixa = labels.map(f => faixas[f].disco);
            const ramFaixa = labels.map(f => faixas[f].ram);

            // grafico
            const ctxCpuRam = document.getElementById('cpuRamChart').getContext('2d');

            new Chart(ctxCpuRam, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'CPU %',
                            data: cpuFaixa,
                            backgroundColor: '#43d33f',
                            borderRadius: 4
                        },
                        {
                            label: 'GPU %',
                            data: gpuFaixa,
                            backgroundColor: '#ff3131',
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { labels: { color: '#a8a8a8' } }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: '#a8a8a8' },
                            grid: { color: '#3a3a3a' }
                        },
                        x: {
                            ticks: { color: '#a8a8a8' },
                            grid: { display: false }
                        }
                    }
                }
            });

            const ctxDisk = document.getElementById('diskChart').getContext('2d');

            new Chart(ctxDisk, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Disco %',
                            data: discoFaixa,
                            borderColor: '#50d050',
                            backgroundColor: 'rgba(80, 208, 80, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'RAM %',
                            data: ramFaixa,
                            borderColor: '#D4D4D4',
                            backgroundColor: 'rgba(60, 108, 60, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { labels: { color: '#a8a8a8' } }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: '#a8a8a8' },
                            grid: { color: '#3a3a3a' }
                        },
                        x: {
                            ticks: { color: '#a8a8a8' },
                            grid: { display: false }
                        }
                    }
                }
            });
        })
        .catch(err => console.error("Erro ao carregar JSON:", err));

    // document.addEventListener('DOMContentLoaded', function () {

    //     const filterTriggerBtn = document.getElementById('filter-alerts-btn');
    //     const modal = document.getElementById('alerts-filter-modal');
    //     const closeBtn = document.querySelector('.close-btn-filter');
    //     const filterOptions = document.querySelectorAll('.filter-option');
    //     const applyBtn = document.getElementById('apply-filters-btn');
    //     const clearBtn = document.getElementById('clear-filters-btn');
    //     const filterStatusSpan = document.getElementById('filter-status');
    //     const alertItems = document.querySelectorAll('.alert-item');

    //     let selectedFilters = {
    //         month: null,
    //         component: null
    //     };

    //     const MONTH_NAMES = {
    //         '01': 'Jan',
    //         '02': 'Fev',
    //         '03': 'Mar',
    //         '04': 'Abr',
    //         '05': 'Mai',
    //         '06': 'Jun',
    //         '07': 'Jul',
    //         '08': 'Ago',
    //         '09': 'Set',
    //         '10': 'Out',
    //         '11': 'Nov',
    //         '12': 'Dez'
    //     };

    //     function applyFilterSimulation() {
    //         let statusText = 'Filtro: ';
    //         let filtersActive = false;

    //         if (selectedFilters.month || selectedFilters.component) {
    //             filtersActive = true;
    //             const monthName = selectedFilters.month ? MONTH_NAMES[selectedFilters.month] : 'Qualquer MÃªs';
    //             const componentName = selectedFilters.component || 'Todo Componente';
    //             statusText += `**${componentName}** em **${monthName}**`;
    //         } else {
    //             statusText += '**Todos**';
    //         }

    //         filterStatusSpan.innerHTML = statusText;

    //         alertItems.forEach(item => {
    //             const itemComponent = item.getAttribute('data-component');
    //             const itemMonth = item.getAttribute('data-month');

    //             const componentMatch = !selectedFilters.component || (itemComponent === selectedFilters.component);
    //             const monthMatch = !selectedFilters.month || (itemMonth === selectedFilters.month);

    //             if (componentMatch && monthMatch) {
    //                 item.style.display = 'flex';
    //             } else {
    //                 item.style.display = 'none';
    //             }
    //         });

    //         modal.style.display = 'none';
    //         console.log('Filtros Aplicados (SimulaÃ§Ã£o):', selectedFilters);
    //     }

    //     if (filterTriggerBtn) {
    //         filterTriggerBtn.onclick = function () {
    //             modal.style.display = 'block';
    //         }
    //     }

    //     if (closeBtn) {
    //         closeBtn.onclick = function () {
    //             modal.style.display = 'none';
    //         }
    //     }

    //     window.onclick = function (event) {
    //         if (event.target == modal) {
    //             modal.style.display = 'none';
    //         }
    //     }

    //     filterOptions.forEach(option => {
    //         option.addEventListener('click', function () {
    //             const filterType = this.getAttribute('data-filter');
    //             const filterValue = this.getAttribute('data-value');

    //             if (this.classList.contains('selected-filter')) {
    //                 this.classList.remove('selected-filter');
    //                 selectedFilters[filterType] = null;
    //             } else {
    //                 document.querySelectorAll(`.filter-option[data-filter="${filterType}"]`).forEach(btn => {
    //                     btn.classList.remove('selected-filter');
    //                 });
    //                 this.classList.add('selected-filter');
    //                 selectedFilters[filterType] = filterValue;
    //             }
    //         });
    //     });

    //     applyBtn.onclick = function () {
    //         applyFilterSimulation();
    //     }

    //     clearBtn.onclick = function () {
    //         filterOptions.forEach(option => {
    //             option.classList.remove('selected-filter');
    //         });
    //         selectedFilters = {
    //             month: null,
    //             component: null
    //         };
    //         applyFilterSimulation();
    //     }
    // });

</script>