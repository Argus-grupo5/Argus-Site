<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../../css/dashboard/funcionarios.css">
  <link rel="stylesheet" href="../../css/dashboard/servers.css">
  <link rel="stylesheet" href="../../css/style.css">
  <script src="./script/dash.js"></script>
  <title>ARGUS | Funcion√°rios</title>
</head>

<body>
  <div class="overlay" id="overlay">
    <div id="config_funcionarios" class="popup">
    </div>
  </div>

  <div id="id_sair">
  </div>

  <header class="desktopNav" id="navDesktop">

  </header>
  <header class="headerTop">
    <div class="geralInfo">
      <div class="info tooltipInfo">
        <div class="server">
          <img src="../../assets/dashboard/desktop/server.svg" alt="" onclick="goServer()">
        </div>
        <div class="serversMonitoring" id="id_servidores_monitorados">
        </div>
        <span class="tooltiptextInfo">
          Servidores em monitoramento
        </span>
      </div>
      <div class="info">
        <div class="bell">
          <img src="../../assets/dashboard/desktop/bell.svg" alt="" onclick="goServer()">
        </div>
        <div class="risk tooltipInfo" id="id_servidores_em_estado_critico">
          <p id="qtd_critico"></p>
          <span class="tooltiptextInfo">
            Servidores em aten√ß√£o
          </span>
        </div>
        <div class="atention tooltipInfo" id="id_servidores_em_estado_de_alerta">
          <p id="qtd_alerta"></p>
          <span class="tooltiptextInfo">
            Servidores em alerta
          </span>
        </div>
      </div>
    </div>

    <div id="editContainer" class="editContainer">
      <img class="iconLapis" src="../../assets/funcionarios/lapis.svg" alt="" onclick="filtrarFuncionarios(true)">
      <span class="tooltiptextInfo">Editar </span>
    </div>
  </header>

  <div class="search">
    <select id="id_filter" onchange="filtrarFuncionarios()">
      <option value="" selected>Todos os cargos</option>
    </select>
    <input type="search" id="id_pesquisa" placeholder="Pesquisar funcion√°rio" oninput="filtrarFuncionarios()">
  </div>
  <div class="containerFunc">
    <div class="funcInfo">
      <div class="funcFoto">
        Foto
      </div>
      <div class="funcName">
        Nome
      </div>
      <div class="funcEmail">
        Email
      </div>
      <div class="funcCargo">
        Cargo
      </div>
      <div class="dtCadastro">
        Data de Cadastro
      </div>
      <div class="functel">
        Telefone
      </div>
      <div id="funcStatusInfo" class="funcStatusInfo">
        
      </div>

    </div>
    <div class="func-list" id="id_func_list">

    </div>

  </div>
</body>

</html>
<script src="./script/kpiGeral.js"></script>
<script>
  let editar = false;
  let funcionariosLista = []; // Inicialize como array vazio;
  const container = document.getElementById("id_func_list");

  window.onload = () => {
    header("funcionario")
    online()
    
    // üîí Para o filtro principal, mostrar TODOS os cargos (incluindo ROOT)
    listarCargo("id_filter", false, true); // filtrarRoot = false, isFiltro = true

    const idEmpresa = sessionStorage.EMPRESA_ID;
    
    buscarPermissoesPorCargo();
    
    fetch(`/usuarios/listarFuncionarios?idEmpresa=${idEmpresa}`)
      .then(res => {
        if (!res.ok) {
          throw new Error(`Erro ${res.status}: ${res.statusText}`);
        }
        return res.json();
      })
      .then(resposta => {
        console.log('Funcion√°rios recebidos:', resposta);
        funcionariosLista = Array.isArray(resposta) ? resposta : [];
        filtrarFuncionarios(editar);
        formatarTelefonesExistentes();
      })
      .catch(error => {
        console.error('Erro ao buscar funcion√°rios:', error);
        funcionariosLista = [];
        filtrarFuncionarios(editar);
      });
      
    setTimeout(aplicarMascaras, 1000);
};window.onload = () => {
    header("funcionario")
    online()
    
    // üîí Para o filtro principal, mostrar TODOS os cargos (incluindo ROOT)
    listarCargo("id_filter", false, true); // filtrarRoot = false, isFiltro = true

    const idEmpresa = sessionStorage.EMPRESA_ID;
    
    buscarPermissoesPorCargo();
    
    fetch(`/usuarios/listarFuncionarios?idEmpresa=${idEmpresa}`)
      .then(res => {
        if (!res.ok) {
          throw new Error(`Erro ${res.status}: ${res.statusText}`);
        }
        return res.json();
      })
      .then(resposta => {
        console.log('Funcion√°rios recebidos:', resposta);
        funcionariosLista = Array.isArray(resposta) ? resposta : [];
        filtrarFuncionarios(editar);
        formatarTelefonesExistentes();
      })
      .catch(error => {
        console.error('Erro ao buscar funcion√°rios:', error);
        funcionariosLista = [];
        filtrarFuncionarios(editar);
      });
      
    setTimeout(aplicarMascaras, 1000);
};

function listarCargo(elementoPai, filtrarRoot = true, isFiltro = false) {
    const select = document.getElementById(elementoPai);
    const idEmpresa = sessionStorage.EMPRESA_ID;

    // Limpar select antes de popular
    if (isFiltro) {
        select.innerHTML = '<option value="" selected>Todos os cargos</option>';
    } else {
        select.innerHTML = '<option value="" disabled selected>Selecione um cargo</option>';
    }
    
    fetch(`/usuarios/listarCargo?idEmpresa=${idEmpresa}`)
      .then(res => res.json())
      .then(cargos => {
        cargos.forEach(c => {
          // üîí Para filtros, mostrar todos os cargos (incluindo ROOT)
          // Para forms (adi√ß√£o/edi√ß√£o), filtrar ROOT
          if (filtrarRoot && !isFiltro && c.cargo === 'ROOT') {
            return; // Pula o cargo ROOT apenas em forms, n√£o no filtro
          }
          
          const option = document.createElement("option");
          option.value = c.id;
          option.textContent = c.cargo;
          select.appendChild(option);
        });
      })
      .catch(err => console.error("Erro ao carregar cargos:", err));
}

  //  Buscar informa√ß√µes sobre o cargo do usu√°rio que est√° logado
  function buscarPermissoesPorCargo() {
    if (sessionStorage.CARGO_CARGO) {
      const nomeCargo = sessionStorage.CARGO_CARGO;
      const idEmpresa = sessionStorage.EMPRESA_ID;

      fetch(`/usuarios/listarCargo?idEmpresa=${idEmpresa}`)
        .then(res => res.json())
        .then(cargos => {
          // Encontrar o cargo com o nome correspondente
          const cargoEncontrado = cargos.find(c => c.cargo === nomeCargo);

          if (cargoEncontrado) {
            console.log('PERMISS√ïES DO CARGO LOGADO:');
            console.log('Cargo:', nomeCargo);
            console.log('Permiss√µes retornadas:', cargoEncontrado);

            // 0 = N√ÉO, 1 = SIM (conforme seu INSERT no banco)
            sessionStorage.PERMISSAO_ADICIONAR = cargoEncontrado.permissao_adicionar === 1 ? 'SIM' : 'N√ÉO';
            sessionStorage.PERMISSAO_EDITAR = cargoEncontrado.permissao_editar === 1 ? 'SIM' : 'N√ÉO';
            sessionStorage.PERMISSAO_DELETAR = cargoEncontrado.permissao_excluir === 1 ? 'SIM' : 'N√ÉO';

            console.log(`Pode adicionar: ${sessionStorage.PERMISSAO_ADICIONAR}`);
            console.log(`Pode editar: ${sessionStorage.PERMISSAO_EDITAR}`);
            console.log(`Pode deletar: ${sessionStorage.PERMISSAO_DELETAR}`);

          } else {
            console.log('Cargo n√£o encontrado na lista:', nomeCargo);
            console.log('Cargos dispon√≠veis:', cargos);
          }
        })
        .catch(err => {
          console.error('Erro ao buscar cargos:', err);
        });
    } else {
      console.warn('Nome do cargo n√£o encontrado no sessionStorage');
    }
  }

  function online() {
    fetch("/usuarios/online", {
      method: "put",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        status: 1,
        idServer: sessionStorage.USER_ID
      }),
    })
      .then(response => {
        if (!response.ok) throw new Error("Erro ao alterar usu√°rio");
        return response.json();
      })
      .catch(error => {
        console.error(`#ERRO: ${error}`);
        return false;
      });
  }

  function filtrarFuncionarios(edit) {
    console.log("Edit mode:", edit);
    console.log("Funcionarios lista:", funcionariosLista);
    
    const filtro = document.getElementById("id_filter").value;
    const pesquisa = document.getElementById("id_pesquisa").value.toLowerCase();
    const container = document.getElementById("id_func_list");
    container.innerHTML = "";
    
    // Verifique se funcionariosLista est√° definido
    if (!funcionariosLista || !Array.isArray(funcionariosLista)) {
      console.error("funcionariosLista n√£o est√° definido ou n√£o √© um array");
      funcionariosLista = []; // Garante que seja um array
      return;
    }
    
    var contStatus = 0;

    // Obter permiss√µes do usu√°rio logado
    const podeEditar = sessionStorage.PERMISSAO_EDITAR === 'SIM';
    const podeExcluir = sessionStorage.PERMISSAO_DELETAR === 'SIM';
    const podeAdicionar = sessionStorage.PERMISSAO_ADICIONAR === 'SIM';
    const isRoot = sessionStorage.CARGO_CARGO === 'ROOT';
    const userId = sessionStorage.USER_ID; // ID do usu√°rio logado

    // Mostrar/ocultar √≠cone de edi√ß√£o baseado nas permiss√µes
    if (podeEditar || podeExcluir || podeAdicionar || isRoot) {
      if (!edit) {
        editContainer.innerHTML = `
          <img class="iconLapis" src="../../assets/funcionarios/lapis.svg" alt="" onclick="filtrarFuncionarios(true)">
          <span class="tooltiptextInfo">Editar </span>
        `;
      } else {
        editContainer.innerHTML = `
          <img class="iconLapis" src="../../assets/funcionarios/salvarAlt.svg" alt="" onclick="filtrarFuncionarios(false)" >
          <span class="tooltiptextInfo">Salvar </span>
        `;
      }
    } else {
      editContainer.innerHTML = ''; // Esconde o √≠cone se n√£o tiver permiss√£o
    }

    if (!edit) {
      editar = false;
      funcStatusInfo.innerHTML = ``;
      
      for (let i = 0; i < funcionariosLista.length; i++) {
        const cargoIgual = filtro === "" || funcionariosLista[i].cargoId == filtro;
        const pesquisaIgual =
          funcionariosLista[i].nome.toLowerCase().includes(pesquisa) ||
          funcionariosLista[i].email.toLowerCase().includes(pesquisa) ||
          funcionariosLista[i].cargo.toLowerCase().includes(pesquisa);

        if (funcionariosLista[i].sobrenome == null) {
          funcionariosLista[i].sobrenome = ""
        }

        if (cargoIgual && pesquisaIgual) {
          contStatus++;
          const statusIcon = `<img class="" alt="">`;
          container.innerHTML += `
            <div id="funcItem" class="funcionario-item" data-idFuncionario=${funcionariosLista[i].id}>
              <div class="funcFoto">
                <img src="../../assets/fotoPerfil/${funcionariosLista[i].foto_perfil}" alt="Foto">
              </div>
              <div class="funcName">${funcionariosLista[i].nome} ${funcionariosLista[i].sobrenome}</div>
              <div class="funcEmail">${funcionariosLista[i].email}</div>
              <div class="funcCargo">${funcionariosLista[i].cargo}</div>
              <div class="dtCadastro">${funcionariosLista[i].data_cadastro}</div>
              <div class="functel">${funcionariosLista[i].telefone}</div>
              <div id="status${contStatus}"class="funcStatus">
                ${statusIcon}
              </div>
            </div>`;
        }
      }
    }
    else if (edit) {
      editar = true;

      // Atualizar cabe√ßalho apenas se tiver permiss√£o para adicionar
      if (podeAdicionar || isRoot) {
        funcStatusInfo.innerHTML = `<img  class= "buttons-edit" src="../../assets/funcionarios/editGreen.svg" alt="" onclick="pop_up_adicionar()">`;
      } else {
        funcStatusInfo.innerHTML = ``;
      }

      for (let i = 0; i < funcionariosLista.length; i++) {
        const cargoIgual = filtro === "" || funcionariosLista[i].cargoId == filtro;
        const pesquisaIgual =
          funcionariosLista[i].nome.toLowerCase().includes(pesquisa) ||
          funcionariosLista[i].email.toLowerCase().includes(pesquisa);

        if (funcionariosLista[i].sobrenome == null) {
          funcionariosLista[i].sobrenome = ""
        }

        if (cargoIgual && pesquisaIgual) {
          let botoesAcao = '';
          
          // üîí VERIFICA√á√ïES DE SEGURAN√áA
          const isUsuarioRoot = funcionariosLista[i].cargo === 'ROOT';
          const isProprioUsuario = funcionariosLista[i].id == userId;
          
          // Verificar permiss√µes para mostrar os bot√µes apropriados
          if ((podeEditar || isRoot) && !isUsuarioRoot && !isProprioUsuario) {
            botoesAcao += `<img class="buttons-edit" src="../../assets/funcionarios/editYellow.svg" alt="Editar" onclick="pop_up_editar(${i})">`;
          }
          
          if ((podeExcluir || isRoot) && !isUsuarioRoot && !isProprioUsuario) {
            botoesAcao += `<img class="buttons-edit" src="../../assets/funcionarios/iconDelete.svg" alt="Deletar" onclick="pop_up_excluir(${i})">`;
          }
          
          // Mensagens para casos restritos
          if (isUsuarioRoot) {
            botoesAcao = '<span class="texto-restrito">Usu√°rio ROOT</span>';
          } else if (isProprioUsuario) {
            botoesAcao = '<span class="texto-restrito">Voc√™</span>';
          }
          
          // Se n√£o tiver nenhuma permiss√£o, mostra apenas um espa√ßo vazio
          if (!botoesAcao) {
            botoesAcao = '&nbsp;';
          }

          container.innerHTML += `
            <div id="funcItem" class="funcionario-item" data-idFuncionario=${funcionariosLista[i].id}>
              <div class="funcFoto">
                <img src="../../assets/fotoPerfil/${funcionariosLista[i].foto_perfil}" alt="Foto">
              </div>
              <div class="funcName">${funcionariosLista[i].nome} ${funcionariosLista[i].sobrenome}</div>
              <div class="funcEmail">${funcionariosLista[i].email}</div>
              <div class="funcCargo">${funcionariosLista[i].cargo}</div>
              <div class="dtCadastro">${funcionariosLista[i].data_cadastro}</div>
              <div class="functel">${funcionariosLista[i].telefone}</div>
              <div class="funcStatus">
                ${botoesAcao}
              </div>
            </div>`;
        }
      }
    }
  }

function pop_up_adicionar() {
    abrir_popup();
    config_funcionarios.innerHTML = `
      <h1>Criar Usu√°rio</h1>
      <div class="inputs">
        <div class="input-label-wrapper">
          <span class="input-label">Nome</span>
          <span class="obrigatorio">*Obrigat√≥rio</span>
        </div>
        <input type="text" id="ipt_nome" placeholder="Digite o nome do funcion√°rio" required>

        <div class="input-label-wrapper">
          <span class="input-label">Sobrenome</span>
          <span class="obrigatorio">*Obrigat√≥rio</span>
        </div>
        <input type="text" id="ipt_sobrenome" placeholder="Digite o sobrenome" required>
        
        <div class="input-label-wrapper">
          <span class="input-label">Cargo</span>
          <span class="obrigatorio">*Obrigat√≥rio</span>
        </div>
        <select id="ipt_cargo">
            <option value="" disabled selected>Selecione um cargo</option>
        </select>
        
        <div class="input-label-wrapper">
          <span class="input-label">Email</span>
          <span class="obrigatorio">*Obrigat√≥rio</span>
        </div>
        <input type="email" id="ipt_email" placeholder="exemplo@empresa.com" required>
        
        <div class="input-label-wrapper">
          <span class="input-label">Senha</span>
          <span class="obrigatorio">*Obrigat√≥rio</span>
        </div>
        <input type="password" id="ipt_senha" placeholder="M√≠nimo 8 caracteres com letras e n√∫meros" required>
        
        <div class="input-label-wrapper">
          <span class="input-label">Confirmar senha</span>
          <span class="obrigatorio">*Obrigat√≥rio</span>
        </div>
        <input type="password" id="ipt_confirmar_senha" placeholder="Digite a senha novamente" required>
        
        <div class="input-label-wrapper">
          <span class="input-label">Telefone</span>
          <span class="obrigatorio">*Obrigat√≥rio</span>
        </div>
        <input type="tel" id="ipt_telefone" placeholder="(11) 99999-9999" required>
      </div>
      <div id="mensagem_erro"></div>
      <div class="btns_popup">
        <button class="btn cadastrar" onclick="funcao_adicionar()">Cadastrar</button>
        <button class="btn fechar" onclick="fechar_popup()">Fechar</button>
      </div>
    `;
    
    // üîí Para forms, filtrar ROOT (filtrarRoot = true, isFiltro = false)
    listarCargo("ipt_cargo", true, false);
    
    setTimeout(aplicarMascaras, 100);
}

  function funcao_adicionar() {
    var nomeVar = ipt_nome.value.trim();
    var sobrenomeVar = ipt_sobrenome.value.trim();
    var cargoVar = ipt_cargo.value;
    var emailVar = ipt_email.value.trim();
    var senhaVar = ipt_senha.value;
    var confirmacao_senhaVar = ipt_confirmar_senha.value;
    
    // MANTER A FORMATA√á√ÉO DA M√ÅSCARA (n√£o remover caracteres)
    var telefoneVar = ipt_telefone.value;
    
    var idEmpresaVar = sessionStorage.EMPRESA_ID;

    if (nomeVar === "") {
      marcarErro(ipt_nome, "O campo nome est√° em branco.");
      return;
    }
    if (sobrenomeVar === "") {
      marcarErro(ipt_sobrenome, "O campo sobrenome est√° em branco.");
      return;
    }
    if (cargoVar === "") {
      marcarErro(ipt_cargo, "O campo cargo est√° em branco.");
      return;
    }
    if (emailVar === "") {
      marcarErro(ipt_email, "O campo email est√° em branco.");
      return;
    }
    if (senhaVar === "") {
      marcarErro(ipt_senha, "O campo senha est√° em branco.");
      return;
    }
    if (confirmacao_senhaVar === "") {
      marcarErro(ipt_confirmar_senha, "O campo confirmar senha est√° em branco.");
      return;
    }

    // ‚úÖ VALIDA√á√ÉO CORRIGIDA - verificar formato em vez de d√≠gitos
    if (!/^\(\d{2}\) \d{5}-\d{4}$/.test(telefoneVar)) {
        marcarErro(ipt_telefone, "Formato de telefone inv√°lido. Use: (11) 99999-9999");
        return;
    }

    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailVar)) {
      marcarErro(ipt_email, "Digite um e-mail v√°lido");
      return;
    }
    if (senhaVar.length < 8 || !/[A-Za-z]/.test(senhaVar) || !/\d/.test(senhaVar)) {
      marcarErro(ipt_senha, "A senha deve ter pelo menos 8 caracteres, incluindo letras e n√∫meros");
      return;
    }
    if (confirmacao_senhaVar !== senhaVar) {
      marcarErro(ipt_confirmar_senha, "As senhas n√£o coincidem");
      return;
    }

    // üîí Verifica√ß√£o adicional no frontend (opcional mas recomendada)
    // Obter o nome do cargo selecionado para verificar se n√£o √© ROOT
    const selectCargo = document.getElementById('ipt_cargo');
    const cargoSelecionado = selectCargo.options[selectCargo.selectedIndex].text;
    
    if (cargoSelecionado === 'ROOT') {
        marcarErro(ipt_cargo, "N√£o √© poss√≠vel criar usu√°rios ROOT");
        return;
    }

    fetch("/usuarios/funcao_adicionar", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        nomeServer: nomeVar,
        sobrenomeServer: sobrenomeVar,
        cargoServer: cargoVar,
        emailServer: emailVar,
        senhaServer: senhaVar,
        telefoneServer: telefoneVar,
        idEmpresaServer: idEmpresaVar
      }),
    })
      .then(resposta => {
        if (resposta.ok) {
          return resposta.json();
        } else {
          return resposta.text().then(text => { throw new Error(text) });
        }
      })
      .then(data => {
        mostrarErro("Cadastro realizado com sucesso!");
        setTimeout(() => {
          window.location = "funcionarios.html";
        }, 2000);
      })
      .catch(erro => {
        console.error('Erro no cadastro:', erro);
        mostrarErro("Erro ao cadastrar: " + (erro.message || "Tente novamente"));
      });
}

function pop_up_editar(id) {
    // üîí Verificar se √© ROOT antes de abrir o popup
    if (funcionariosLista[id].cargo === 'ROOT') {
        mostrarErro("N√£o √© poss√≠vel editar usu√°rios ROOT");
        return;
    }
    
    // üîí Verificar se √© o pr√≥prio usu√°rio
    if (funcionariosLista[id].id == sessionStorage.USER_ID) {
        mostrarErro("N√£o √© poss√≠vel editar seu pr√≥prio usu√°rio aqui");
        return;
    }
    
    console.log(funcionariosLista)
    abrir_popup()
    config_funcionarios.innerHTML = `
      <img src="../../assets/dashboard/desktop/btnFechar.svg" alt="Fechar" class="btnFecharPopup" onclick="fechar_popup()">
      <h1>Editar Usu√°rio</h1>
      <div class="inputs">
        <div class="input-label-wrapper">
          <span class="input-label">Nome</span>
        </div>
        <input type="text" id="ipt_nome" value="${funcionariosLista[id].nome} ${funcionariosLista[id].sobrenome}" disabled>

        <div class="input-label-wrapper">
          <span class="input-label">Cargo</span>
          <span class="obrigatorio">*obrigat√≥rio</span>
        </div>
        <select id="ipt_cargo">
            <option value="" disabled selected>Selecione um cargo</option>
        </select>

        <div class="input-label-wrapper">
          <span class="input-label">Email</span>
          <span class="obrigatorio">*obrigat√≥rio</span>
        </div>
        <input type="email" id="ipt_email" value="${funcionariosLista[id].email}" placeholder="exemplo@empresa.com" required>

        <div class="input-label-wrapper">
          <span class="input-label">Telefone</span>
          <span class="obrigatorio">*obrigat√≥rio</span>
        </div>
        <input type="tel" id="ipt_telefone" value="${funcionariosLista[id].telefone}" placeholder="(11) 99999-9999" required>
      </div>
      <div id="mensagem_erro"></div>
      <div class="btns_popup">
        <button class="btn cadastrar" onclick="funcao_editar_funcionario(${funcionariosLista[id].id})">Salvar</button>
        <button class="btn fechar" onclick="fechar_popup()">Cancelar</button>
      </div>
    `;
    setTimeout(aplicarMascaras, 100);
    
    // üîí Para forms, filtrar ROOT (filtrarRoot = true, isFiltro = false)
    listarCargo("ipt_cargo", true, false).then(() => {
        setTimeout(() => {
            document.getElementById("ipt_cargo").value = funcionariosLista[id].cargoId;
            aplicarMascaras();
        }, 100);
    });
}

  function funcao_editar_funcionario(idVar) {
    var cargoVar = ipt_cargo.value;
    var emailVar = ipt_email.value.trim();
    var telefoneVar = ipt_telefone.value;


    if (cargoVar === "") {
      marcarErro(ipt_cargo, "Selecione um cargo.");
      return;
    }
    if (emailVar === "") {
      marcarErro(ipt_email, "O campo email est√° em branco.");
      return;
    }
    if (!/^\(\d{2}\) \d{5}-\d{4}$/.test(telefoneVar)) {
      marcarErro(ipt_telefone, "Telefone deve ter 10 ou 11 n√∫meros (com DDD)");
      return;
    }
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailVar)) {
      marcarErro(ipt_email, "Digite um e-mail v√°lido");
      return;
    }

    fetch("/usuarios/funcao_editar_funcionario", {
      method: 'PUT',
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        cargoServer: cargoVar,
        emailServer: emailVar,
        telefoneServer: telefoneVar, // AGORA FORMATADO
        idServer: idVar
      }),
    })
      .then(resposta => {
        if (resposta.ok) {
          mostrarErro("Altera√ß√£o realizada com sucesso!");
          setTimeout(() => {
            window.location = "funcionarios.html";
          }, 2000);
        } else {
          throw "Houve um erro ao tentar realizar a altera√ß√£o!";
        }
      })
      .catch(erro => {
        console.error(`#ERRO: ${erro}`);
        mostrarErro("Erro ao editar usu√°rio: " + erro);
      });
  }

function pop_up_excluir(id) {
    // üîí Verificar se √© ROOT antes de abrir o popup
    if (funcionariosLista[id].cargo === 'ROOT') {
        mostrarErro("N√£o √© poss√≠vel excluir usu√°rios ROOT");
        return;
    }
    
    // üîí Verificar se √© o pr√≥prio usu√°rio
    if (funcionariosLista[id].id == sessionStorage.USER_ID) {
        mostrarErro("N√£o √© poss√≠vel excluir seu pr√≥prio usu√°rio");
        return;
    }
    
    abrir_popup()
    config_funcionarios.innerHTML = `
    <img src="../../assets/dashboard/desktop/btnFechar.svg" alt="Fechar" class="btnFecharPopup" onclick="fechar_popup()">
    <h1>Deletar Usu√°rio</h1>
    <div class="inputs">
      <p>Deseja deletar o usu√°rio <strong>${funcionariosLista[id].nome} ${funcionariosLista[id].sobrenome}</strong>?</p>
      <p class="aviso">‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita!</p>
    </div>
    <div id="mensagem_erro"></div>
    <div class="btns_popup">
      <button class="btn cadastrar" onclick="funcao_excluir(${funcionariosLista[id].id})">Sim, deletar</button>
      <button class="btn fechar" onclick="fechar_popup()">Cancelar</button>
    </div>
    `;
    mensagem_erro.style.display = 'flex';
}

  function funcao_excluir(idVar) {
    // üîí Verifica√ß√£o final de seguran√ßa no momento da exclus√£o
    const usuario = funcionariosLista.find(f => f.id == idVar);
    if (usuario && usuario.cargo === 'ROOT') {
        mostrarErro("Erro: N√£o √© poss√≠vel excluir usu√°rios ROOT");
        return;
    }
    
    if (idVar == sessionStorage.USER_ID) {
        mostrarErro("Erro: N√£o √© poss√≠vel excluir seu pr√≥prio usu√°rio");
        return;
    }
    
    mostrarErro(`Excluindo o usu√°rio...`);
    
    fetch("/usuarios/funcao_excluir", {
        method: 'DELETE',
        headers: { 
            "Content-Type": "application/json" 
        },
        body: JSON.stringify({
            idServer: idVar
        })
    })
    .then(res => {
        if (res.ok) {
            return res.json();
        }
        throw new Error('Erro ao excluir usu√°rio');
    })
    .then(data => {
        mostrarErro("Funcion√°rio deletado com sucesso!");
        setTimeout(() => {
            window.location.reload();
        }, 2000);
    })
    .catch(err => {
        console.error('Erro na requisi√ß√£o:', err);
        mostrarErro("Erro ao deletar funcion√°rio: " + err.message);
    });
}

  function mostrarErro(msg) {
    mensagem_erro.innerHTML = msg;
    setTimeout(() => {
      mensagem_erro.innerHTML = "";
      fechar_popup();
      window.location.reload()
    }, 5000);
  }

  function marcarErro(input, msg) {
    input.classList.add("erroInput");
    mostrarErro(msg);

    input.scrollIntoView({ behavior: "smooth", block: "center" });

    setTimeout(() => {
      input.classList.remove("erroInput");
    }, 1500);
  }

  function mascaraTelefone(input) {
    input.addEventListener('input', function (e) {
      let value = e.target.value.replace(/\D/g, '');

      if (value.length <= 15) {
        if (value.length <= 2) {
          value = value;
        } else if (value.length <= 7) {
          value = value.replace(/(\d{2})(\d+)/, '($1) $2');
        } else {
          value = value.replace(/(\d{2})(\d{5})(\d+)/, '($1) $2-$3');
        }
        e.target.value = value;
      }

      // Limitar a 11 d√≠gitos (DDD + 9 d√≠gitos)
      if (value.length > 15) {
        e.target.value = value.slice(0, 15);
      }
    });
  }

  function formatarTelefonesExistentes() {
    // Formatando telefones j√° exibidos na lista
    const telefonesNaLista = document.querySelectorAll('.functel');
    telefonesNaLista.forEach(telElement => {
        if (telElement.textContent && telElement.textContent.trim() !== '') {
            let numericValue = telElement.textContent.replace(/\D/g, '');
            if (numericValue.length >= 10) {
                if (numericValue.length <= 11) {
                    numericValue = numericValue.replace(/(\d{2})(\d{5})(\d+)/, '($1) $2-$3');
                    telElement.textContent = numericValue;
                }
            }
        }
    });
}

  function aplicarMascaras() {
    // M√°scaras para telefone
    const telefoneInputs = document.querySelectorAll('input[type="text"][id*="telefone"], input[type="tel"]');
    telefoneInputs.forEach(input => {
      // Formatar valor existente antes de aplicar a m√°scara
      if (input.value) {
        let value = input.value.replace(/\D/g, '');
        if (value.length >= 10) {
          value = value.replace(/(\d{2})(\d{5})(\d+)/, '($1) $2-$3');
          input.value = value;
        }
      }
      mascaraTelefone(input);
      input.placeholder = "(11) 99999-9999";
    });
    

    // Placeholders para outros campos
    const nomeInput = document.getElementById('ipt_nome');
    if (nomeInput) nomeInput.placeholder = "Digite o nome do funcion√°rio";

    const sobrenomeInput = document.getElementById('ipt_sobrenome');
    if (sobrenomeInput) sobrenomeInput.placeholder = "Digite o sobrenome";

    const emailInput = document.getElementById('ipt_email');
    if (emailInput) emailInput.placeholder = "cloud@gmail.com";

    const senhaInput = document.getElementById('ipt_senha');
    if (senhaInput) senhaInput.placeholder = "M√≠nimo 8 caracteres com letras e n√∫meros";

    const confirmarSenhaInput = document.getElementById('ipt_confirmar_senha');
    if (confirmarSenhaInput) confirmarSenhaInput.placeholder = "Digite a senha novamente";
  }

</script>