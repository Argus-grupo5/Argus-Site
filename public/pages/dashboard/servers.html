<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../css/dashboard/servers.css">
    <link rel="stylesheet" href="../../css/style.css">
    <script src="./script/dash.js"></script>
    <title>ARGUS | Servidores</title>
</head>


<body>
    <div id="id_sair">
    </div>

    <div id="modal" class="modal">
        <div class="modal-geral" id="div_modal_label"></div>
    </div>

    <header class="desktopNav" id="navDesktop"></header>

    <header class="headerTop">
        <div class="geralInfo">
            <div class="info tooltipInfo">
                <div class="server">
                    <img src="../../assets/dashboard/desktop/server.svg" alt="">
                </div>
                <div class="serversMonitoring" id="id_servidores_monitorados">
                </div>
                <span class="tooltiptextInfo">
                    Servidores em monitoramento
                </span>
            </div>
            <div class="info">
                <div class="bell">
                    <img src="../../assets/dashboard/desktop/bell.svg" alt="">
                </div>
                <div class="risk tooltipInfo" id="id_servidores_em_estado_critico">
                    <p id="qtd_critico">1</p>
                    <span class="tooltiptextInfo">
                        Servidores em atenção
                    </span>
                </div>
            </div>
        </div>
    </header>

    <div class="search" id="search">
    </div>

    <div class="container">
        <div class="server-list" id="regioes"></div>
    </div>
    </div>
</body>


</html>
<script>
    header("server", sessionStorage.CARGO_CARGO);

    if(sessionStorage.CARGO_CARGO == "ROOT"){
        document.getElementById("search").innerHTML = '<button onclick="abrirModal()">Adicionar server</button>'
    }

    var nome = null;
    var nome_estado = null;
    var sigla_estado = null;

    function listarServidoresTotais() {
        let id = sessionStorage.EMPRESA_ID
        fetch(`/servidores/contarServidores/${id}`, {
            method: "GET",
            headers: { "Content-Type": "application/json" }
        })
            .then((resposta) => {
                resposta.json().then((json) => {
                    console.log(json)
                    elMonitored.innerHTML = json[0].totalServers
                })
            })
    }

    function botaoLimpar() {
        nome = ipt_nome.value;
        nome_estado = ipt_nome_estado.value;
        sigla_estado = ipt_sigla_estado.value;

        div_modal_label.innerHTML = `<h1>Limite Componentes</h1>
            <div class="modal-label" id="div_modal_label">
                <label for="ipt_nome_cpu">Limite CPU:</label>
                <div class="modal-label-comp">
                    <input type="number" name="" id="ipt_maxCPU" placeholder="Digite o limite máximo da CPU">
                    <input type="number" name="" id="ipt_minCPU" placeholder="Digite o mínimo da CPU">
                </div>
            </div>
            <div class="modal-label" id="div_modal_label">
                <label for="ipt_nome_ram">Limite RAM:</label>
                <div class="modal-label-comp">
                    <input type="number" name="" id="ipt_maxRAM" placeholder="Digite o limite máximo da RAM">
                    <input type="number" name="" id="ipt_minRAM" placeholder="Digite o mínimo da RAM">
                </div>
            </div>
            <div class="modal-label" id="div_modal_label">
                <label for="ipt_nome_disco">Limite DISCO:</label>
                <div class="modal-label-comp">
                    <input type="number" name="" id="ipt_maxDISCO" placeholder="Digite o limite máximo do DISCO">
                    <input type="number" name="" id="ipt_minDISCO" placeholder="Digite o mínimo do DISCO">
                    </div>
                </div>
            <div class="modal-label" id="div_modal_label">
                <label for="ipt_nome_rede">Limite REDE:</label>
                <div class="modal-label-comp">
                    <input type="number" name="" id="ipt_maxREDE" placeholder="Digite o limite máximo da REDE">
                    <input type="number" name="" id="ipt_minREDE" placeholder="Digite o mínimo da REDE">
                </div>
            </div>
            <div class="modal-label" id="div_modal_label">
                <label for="ipt_nome_gpu">Limite GPU:</label>
                <div class="modal-label-comp">
                    <input type="number" name="" id="ipt_maxGPU" placeholder="Digite o limite máximo da GPU">
                    <input type="number" name="" id="ipt_minGPU" placeholder="Digite o mínimo da GPU">
                </div>
            </div>
            <div class="modal-label" id="div_modal_label">
                <label for="ipt_nome_gpu">Limite de alertas:</label>
                <div class="modal-label-comp">
                    <input type="number" name="" id="ipt_qtdAlerta" placeholder="Digite o limite máximo da quantidade de alertas">
                </div>
            </div>
            <div class="modal-button">
                <div onclick="fecharModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                        <rect width="24" height="24" fill="none" />
                        <path fill="#fff"
                            d="M6.4 19L5 17.6l5.6-5.6L5 6.4L6.4 5l5.6 5.6L17.6 5L19 6.4L13.4 12l5.6 5.6l-1.4 1.4l-5.6-5.6z" />
                    </svg>
                </div>
                <div onclick="addServidor()" id="modal_prosseguir">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="24" viewBox="0 0 12 24">
                        <rect width="12" height="24" fill="none" />
                        <path fill="#fff" fill-rule="evenodd"
                            d="M10.157 12.711L4.5 18.368l-1.414-1.414l4.95-4.95l-4.95-4.95L4.5 5.64l5.657 5.657a1 1 0 0 1 0 1.414" />
                    </svg>
                </div>
            </div>`;
    };

    function abrirModal() {
        let modal = document.getElementById("modal")
        let conteudo = document.getElementById("div_modal_label")
        modal.style.display = "flex"

        conteudo.innerHTML = `
            <h1>Adicionar servidor</h1>
            <div class="modal-label">
                <label for="ipt_nome">Nome do Servidor:</label>
                <input type="text" name="" id="ipt_nome" placeholder="Digite o nome do servidor">

                <label for="ipt_nome_estado">Nome do Estado:</label>
                <input type="text" name="" id="ipt_nome_estado" placeholder="Digite o nome do estado">

                <label for="ipt_sigla_estado">Sigla do Servidor:</label>
                    <input type="text" name="" id="ipt_sigla_estado" maxlength="2" placeholder="Digite a sigla do estado">
            </div>
            <div class="modal-button">
            </div>
            <div class="modal-button">
            </div>
            <div class="modal-button">
                <div onclick="fecharModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                        <rect width="24" height="24" fill="none" />
                        <path fill="#fff"
                            d="M6.4 19L5 17.6l5.6-5.6L5 6.4L6.4 5l5.6 5.6L17.6 5L19 6.4L13.4 12l5.6 5.6l-1.4 1.4l-5.6-5.6z" />
                    </svg>
                </div>
                <div id="modal_prosseguir" onclick="botaoLimpar()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="24" viewBox="0 0 12 24">
                        <rect width="12" height="24" fill="none" />
                        <path fill="#fff" fill-rule="evenodd"
                            d="M10.157 12.711L4.5 18.368l-1.414-1.414l4.95-4.95l-4.95-4.95L4.5 5.64l5.657 5.657a1 1 0 0 1 0 1.414" />
                    </svg>
                </div>
            </div>`
    }

    function fecharModal() {
        let modal = document.getElementById("modal")
        modal.style.display = "none"
    }

    function addServidor() {

        const maxCPU = ipt_maxCPU.value;
        const minCPU = ipt_minCPU.value;
        const maxRAM = ipt_maxRAM.value;
        const minRAM = ipt_minRAM.value;
        const maxDISCO = ipt_maxDISCO.value;
        const minDISCO = ipt_minDISCO.value;
        const maxREDE = ipt_maxREDE.value;
        const minREDE = ipt_minREDE.value;
        const maxGPU = ipt_maxGPU.value;
        const minGPU = ipt_minGPU.value;
        const qtdAlerta = ipt_qtdAlerta.value;

        function validarLimite(max, min, nome) {
            if (isNaN(max) || isNaN(min)) {
                alert(`Preencha corretamente os valores de ${nome}.`);
                return false;
            }
            if (max < min) {
                alert(`O valor máximo de ${nome} não pode ser menor que o mínimo.`);
                return false;
            }
            if (max > 100 || max < 1) {
                alert(`O valor máximo de ${nome} deve ser entre 1 e 100.`);
                return false;
            }
            if (min < 0) {
                alert(`O valor mínimo de ${nome} não pode ser menor que 0.`);
                return false;
            }
            if (min > max) {
                alert(`O valor mínimo de ${nome} não pode ser maior que o máximo.`);
                return false;
            }
            return true;
        }

        if (
            !validarLimite(maxCPU, minCPU, "CPU") ||
            !validarLimite(maxRAM, minRAM, "RAM") ||
            !validarLimite(maxDISCO, minDISCO, "DISCO") ||
            !validarLimite(maxREDE, minREDE, "REDE") ||
            !validarLimite(maxGPU, minGPU, "GPU")
        ) {
            return;
        }

        fetch("/servidores/addServidor", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                nomeServer: nome,
                empresaServer: sessionStorage.EMPRESA_ID,
                nomeEstadoServer: nome_estado,
                siglaEstadoServer: sigla_estado,
                maxCpuServer: maxCPU,
                minCpuServer: minCPU,
                maxRamServer: maxRAM,
                minRamServer: minRAM,
                maxDiscoServer: maxDISCO,
                minDiscoServer: minDISCO,
                maxRedeServer: maxREDE,
                minRedeServer: minREDE,
                maxGpuServer: maxGPU,
                minGpuServer: minGPU,
                qtdAlerta: qtdAlerta
            })
        })
            .then((resposta) => {
                console.log(resposta)
                if (resposta.ok) {
                    console.log("Cadastro realizado com sucesso")
                    fecharModal();
                    listarEstados();
                } else {
                    console.log("Erro ao cadastrar")
                }
            })
            .catch((erro) => console.error(`#ERRO: ${erro}`))
    }

    function listarEstados() {
        const id = sessionStorage.EMPRESA_ID;
        const regioes = document.getElementById("regioes")
        regioes.innerHTML = ""
        fetch(`/servidores/listar/${id}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then((resposta) => {
                resposta.json().then(json => {
                    console.log(json)
                    for (let i = 0; i < json.length; i++) {
                        var qtdServer = json[i].total_servidores > 1 ? "Servidores" : "Servidor"

                        var risco;
                        if (i == 0) {
                            risco = "../../assets/dashboard/desktop/danger.svg"
                        } else {
                            risco = "../../assets/dashboard/desktop/ok.svg"
                        }
                        regioes.innerHTML += `<div class="slakk">
                            <div class="regioes-card" data-sigla="${json[i].sigla_estado}" onclick="listarServidores(this)">
                                <img src="${risco}"></img>
                                <p>${json[i].nome_estado} - ${json[i].sigla_estado} |
                                     ${json[i].total_servidores} ${qtdServer}</p>
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 15 15"><rect width="15" height="15" fill="none"/><path fill="#fff" d="M7.5 12L0 4h15z"/></svg>
                                </div>
                                <div class="server-list" id="id_server_list_${json[i].sigla_estado}">
                                </div>
                        </div>`
                    }
                })
            })
    }

    const servidoresS3 = []
    const semanal = [
  {
    "Identificador": "xbox-cloud-br-sp-1",
    "CPU": "17",
    "Ram": "19",
    "Disco": "16",
    "GPU": "14",
    "Rede": "13",
    "Estado": "SP",
    "data": "24-11-2025",
    "hora": "00:00:00"
  },
  {
    "Identificador": "xbox-cloud-br-sp-1",
    "CPU": "29",
    "Ram": "15",
    "Disco": "27",
    "GPU": "30",
    "Rede": "18",
    "Estado": "SP",
    "data": "25-11-2025",
    "hora": "00:00:00"
  },
  {
    "Identificador": "xbox-cloud-br-sp-1",
    "CPU": "21",
    "Ram": "23",
    "Disco": "14",
    "GPU": "19",
    "Rede": "16",
    "Estado": "SP",
    "data": "26-11-2025",
    "hora": "00:00:00"
  },
  {
    "Identificador": "xbox-cloud-br-sp-1",
    "CPU": "26",
    "Ram": "28",
    "Disco": "21",
    "GPU": "17",
    "Rede": "11",
    "Estado": "SP",
    "data": "27-11-2025",
    "hora": "00:00:00"
  },
  {
    "Identificador": "xbox-cloud-br-sp-1",
    "CPU": "15",
    "Ram": "13",
    "Disco": "25",
    "GPU": "29",
    "Rede": "20",
    "Estado": "SP",
    "data": "28-11-2025",
    "hora": "00:00:00"
  },
  {
    "Identificador": "xbox-cloud-br-sp-1",
    "CPU": "18",
    "Ram": "30",
    "Disco": "22",
    "GPU": "16",
    "Rede": "14",
    "Estado": "SP",
    "data": "29-11-2025",
    "hora": "00:00:00"
  },
  {
    "Identificador": "xbox-cloud-br-sp-1",
    "CPU": "27",
    "Ram": "24",
    "Disco": "19",
    "GPU": "23",
    "Rede": "17",
    "Estado": "SP",
    "data": "30-11-2025",
    "hora": "00:00:00"
  }
]
    const data = []

async function listarServidores(objetoHTML) {
    const siglaObjeto = objetoHTML.dataset.sigla;
    const id = sessionStorage.EMPRESA_ID;
    const filhos = objetoHTML.children;
    filhos[2].style.transform = "rotate(180deg)";
    const divServ = document.getElementById(`id_server_list_${siglaObjeto}`);
    divServ.innerHTML = "";
    objetoHTML.setAttribute('onclick', "fecharServidores(this)");

    try {
        const resposta = await fetch(`/servidores/listarServidores/${id}/${siglaObjeto}`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
        });

        const json = await resposta.json();
        console.log('Servidores:', json);

        servidoresS3.length = 0;

        json.forEach(servidor => {
            servidoresS3.push(servidor.nome);
            const riscoInicial = servidor.nome === "serv1" 
                ? "../../assets/dashboard/desktop/danger.svg" 
                : "../../assets/dashboard/desktop/ok.svg";

            divServ.innerHTML += `
                <div class="server-object" data-servidor="${servidor.nome}" id="servidor-${servidor.nome}" onclick="clicarServidor('${servidor.nome}')">
                    <div class="serverIcon tooltipInfo">
                        <img class="server-icon-status" src="${riscoInicial}" alt="Status" data-servidor="${servidor.nome}">
                    </div>
                    <div class="serverName">${servidor.nome}</div>
                    <div class="serverLocation"><p>CPU, RAM, DISCO</p></div>
                </div>
            `;
        });

        for (let i = 0; i < servidoresS3.length; i++) {
            console.log('Buscando dados para:', servidoresS3[i]);
            await semana(servidoresS3[i]);
        }

        calcularTotalGeralPorServidor(semanal);

    } catch (err) {
        console.error('Erro no fetch:', err);
    }
}

    function fecharServidores(objetoHTML) {
        const siglaObjeto = objetoHTML.dataset.sigla
        const divServ = document.getElementById(`id_server_list_${siglaObjeto}`)
        divServ.innerHTML = ""
        const filhos = objetoHTML.children
        console.log(filhos)
        filhos[2].style.transform = "rotate(0deg)"

        objetoHTML.setAttribute('onclick', "listarServidores(this)")
    }
      function clicarServidor(nomeServidor){
    localStorage.setItem("servidorSelecionado", nomeServidor);

    console.log("servidor salvo: ", nomeServidor);

    window.location.href = "dashAlertas.html";
}   
const totais = {};

function atualizarStatusRegiao() {
    const regiaoSP = document.querySelector('.regioes-card[data-regiao="SP"] .regiao-icon-status');
    
    if (!regiaoSP) return;

    let regiaoCritica = false;

    Object.keys(totais).forEach(servidorNome => {
        const total = totais[servidorNome].total;

        if (servidorNome.includes('sp-') || servidorNome === 'eduardo') {
            if (total > 50) {
                regiaoCritica = true;
            }
        }
    });

    regiaoSP.src = regiaoCritica
        ? '../../assets/dashboard/desktop/danger.svg'
        : '../../assets/dashboard/desktop/ok.svg';
}
document.addEventListener('DOMContentLoaded', async function () {
    const cardSP = document.querySelector('.regioes-card[data-regiao="SP"]');
    if (cardSP) {
        await listarServidores(cardSP);
    }
});


function calcularTotalGeralPorServidor(dados) {
    Object.keys(totais).forEach(key => delete totais[key]);
    
    dados.forEach(item => {
        const servidor = item.Identificador;
        
        if (!totais[servidor]) {
            totais[servidor] = { total: 0 };
        }

        const cpu   = Number(item.CPU)   || 0;
        const ram   = Number(item.Ram)   || 0;
        const disco = Number(item.Disco) || 0;
        const gpu   = Number(item.GPU)   || 0;
        
        totais[servidor].total += (cpu + ram + disco + gpu);
    });


    Object.keys(totais).forEach(servidorNome => {
        const total = totais[servidorNome].total;
        console.log(`${servidorNome}: ${total} alertas totais`);
        
        const imgStatus = document.querySelector(
            `[data-servidor="${servidorNome}"] .server-icon-status`
        );
        
        if (imgStatus) {
            imgStatus.src = total > 50
                ? '../../assets/dashboard/desktop/danger.svg'
                : '../../assets/dashboard/desktop/ok.svg';
        }
    });

    atualizarStatusRegiao();

    // semanal.length = 0;
}

  async function semana(nomeServidor) {
    const hoje = new Date();
    let dias = 7;
    let dia = hoje.getDate();


    // for (let i = 7; i >= 1; i--) {
    //   if((hoje.getDate() - i) <= 0){
    //     dia = new Date(hoje.getDate(), hoje.getMonth(), 0).getDate();
    //   }
    //   const key = `${servidorSelecionado}-${hoje.getFullYear()}-${hoje.getMonth()}-${dia - i}.json`;

    //   try {
    //     const res = await fetch(`https://argus-s3-client.s3.us-east-1.amazonaws.com/suporte/alertas/${key}`);

    //     if (!res.ok) {
    //       console.log("Arquivo não encontrado:", key);
//     //       continue;
//     //     }

//     //     const data = await res.json();
//         semanal.push([
//   {
//     "Identificador": "xbox-cloud-br-sp-1",
//     "CPU": "17",
//     "Ram": "19",
//     "Disco": "16",
//     "GPU": "14",
//     "Rede": "13",
//     "Estado": "SP",
//     "data": "24-11-2025",
//     "hora": "00:00:00"
//   },
//   {
//     "Identificador": "xbox-cloud-br-sp-1",
//     "CPU": "29",
//     "Ram": "15",
//     "Disco": "27",
//     "GPU": "30",
//     "Rede": "18",
//     "Estado": "SP",
//     "data": "25-11-2025",
//     "hora": "00:00:00"
//   },
//   {
//     "Identificador": "xbox-cloud-br-sp-1",
//     "CPU": "21",
//     "Ram": "23",
//     "Disco": "14",
//     "GPU": "19",
//     "Rede": "16",
//     "Estado": "SP",
//     "data": "26-11-2025",
//     "hora": "00:00:00"
//   },
//   {
//     "Identificador": "xbox-cloud-br-sp-1",
//     "CPU": "26",
//     "Ram": "28",
//     "Disco": "21",
//     "GPU": "17",
//     "Rede": "11",
//     "Estado": "SP",
//     "data": "27-11-2025",
//     "hora": "00:00:00"
//   },
//   {
//     "Identificador": "xbox-cloud-br-sp-1",
//     "CPU": "15",
//     "Ram": "13",
//     "Disco": "25",
//     "GPU": "29",
//     "Rede": "20",
//     "Estado": "SP",
//     "data": "28-11-2025",
//     "hora": "00:00:00"
//   },
//   {
//     "Identificador": "xbox-cloud-br-sp-1",
//     "CPU": "18",
//     "Ram": "30",
//     "Disco": "22",
//     "GPU": "16",
//     "Rede": "14",
//     "Estado": "SP",
//     "data": "29-11-2025",
//     "hora": "00:00:00"
//   },
//   {
//     "Identificador": "xbox-cloud-br-sp-1",
//     "CPU": "27",
//     "Ram": "24",
//     "Disco": "19",
//     "GPU": "23",
//     "Rede": "17",
//     "Estado": "SP",
//     "data": "30-11-2025",
//     "hora": "00:00:00"
//   }
// ]);
    //     console.log(semanal)

    //   } catch (err) {
    //     console.error("Erro ao fazer fetch:", err);
    //   }
    }

    console.log("Todos os dados carregados:", semanal);
    console.log("Primeiro JSON:", semanal[0]);

//   } 


    // updateKPIs();
    // filtragem_Servidores();
    listarEstados()
    listarServidoresTotais();
</script>