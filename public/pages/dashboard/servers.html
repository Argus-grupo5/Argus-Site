<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../css/dashboard/servers.css">
    <link rel="stylesheet" href="../../css/style.css">
    <script src="./script/dash.js"></script>
    <title>ARGUS | Servidores</title>
</head>


<body>
    <div id="id_sair">
    </div>

    <header class="desktopNav" id="navDesktop"></header>

    <header class="headerTop">
        <div class="geralInfo">
            <div class="info tooltipInfo">
                <div class="server">
                    <img src="../../assets/dashboard/desktop/server.svg" alt="">
                </div>
                <div class="serversMonitoring" id="id_servidores_monitorados">
                </div>
                <span class="tooltiptextInfo">
                    Servidores em monitoramento
                </span>
            </div>
            <div class="info">
                <div class="bell">
                    <img src="../../assets/dashboard/desktop/bell.svg" alt="">
                </div>
                <div class="risk tooltipInfo" id="id_servidores_em_estado_critico">
                    <p id="qtd_critico"></p>
                    <span class="tooltiptextInfo">
                        Servidores em atenção
                    </span>
                </div>
                <div class="atention tooltipInfo" id="id_servidores_em_estado_de_alerta">
                    <p id="qtd_alerta"></p>
                    <span class="tooltiptextInfo">
                        Servidores em alerta
                    </span>
                </div>
            </div>
        </div>
    </header>

    <div class="search">
        <select id="id_filter" onchange="filtragem_Servidores()">
            <option value="Nivel_d" selected>Nível (Decrescente)</option>
            <option value="Nivel_c">Nível (Crescente)</option>
            <option value="Critico_d">Crítico (Decrescente)</option>
            <option value="Critico_c">Crítico (Crescente)</option>
            <option value="Alerta_d">Alerta (Decrescente)</option>
            <option value="Alerta_c">Alerta (Crescente)</option>
            <option value="Bom">Bom Estado</option>
        </select>
        <input type="search" id="id_pesquisa" placeholder="Pesquisar por um servidor" oninput="filtragem_Servidores()">
    </div>

    <div class="container">
        <div class="serverInfo">
            <div class="serverIcon tooltipInfo">
                <img style="width: 2vw;" src="../../assets/dashboard/desktop/tip.svg" alt="Informação sobre os dados">
                <span class="tooltiptextInfo">
                    Dados são atualizados a cada 60s
                </span>
            </div>
            <div class="serverName">
                Servidor
            </div>
            <div class="serverStatus">
                Nível de Risco
            </div>
            <div class="serverComponents">
                Recursos em Risco
            </div>
            <div class="serverLocation">
                Localização
            </div>
        </div>
        <div class="server-list" id="id_server_list">
        </div>
    </div>
    </div>
</body>


</html>
<script>
    header("server");

    const servers = [
        { name: "Servidor Geforce Now", nivel: 4, recursos: ["CPU", "RAM"], localizacao: "São Paulo - SP" },
        { name: "Servidor SPTech", nivel: 3, recursos: ["CPU", "GPU"], localizacao: "São Paulo - SP" },
        { name: "Servidor BandTec", nivel: 5, recursos: ["CPU", "GPU", "Armazenamento"], localizacao: "São Paulo - SP" },
        { name: "Servidor Xbox", nivel: 1, recursos: ["GPU"], localizacao: "Rio de Janeiro - RJ" },
        { name: "Servidor Stadia", nivel: 2, recursos: ["CPU", "RAM"], localizacao: "Belo Horizonte - MG" }
    ];

    const elMonitored = document.getElementById("id_servidores_monitorados");
    const elQtdCritico = document.getElementById("qtd_critico");
    const elQtdAlerta = document.getElementById("qtd_alerta");
    const elServerList = document.getElementById("id_server_list");
    elMonitored.textContent = servers.length;

    function getRiskStatusFromLevel(nivel) {
        const n = Number(nivel);
        if (n === 1) return "ok";
        if (n > 1 && n <= 3) return "atention";
        if (n >= 4) return "danger";
        return "indisponivel";
    }

    // Atualiza KPIs 
    function updateKPIs() {
        let critico = 0;
        let alerta = 0;
        for (let i = 0; i < servers.length; i++) {
            const status = getRiskStatusFromLevel(servers[i].nivel);
            if (status === "danger") critico++;
            else if (status === "atention") alerta++;
        }
        elQtdCritico.textContent = critico;
        elQtdAlerta.textContent = alerta;
    }

    // Cria um servidor como card
    function gerar_server(idx) {
        const s = servers[idx];
        const status = getRiskStatusFromLevel(s.nivel);
        const recursosText = Array.isArray(s.recursos) ? s.recursos.join(", ") : String(s.recursos);

        elServerList.innerHTML += `
      <div class="server-object">
        <div class="serverIcon tooltipInfo">
          <img class="server-icon-status" src="../../assets/dashboard/desktop/${status}.svg" alt="Status do servidor">
        </div>
        <div class="serverName">${s.name}</div>
        <div class="serverStatus"><progress value="${s.nivel}" max="5"></progress></div>
        <div class="serverComponents">${recursosText}</div>
        <div class="serverLocation">${s.localizacao}</div>
      </div>
    `;
    }

    // FIltra e ordena os servidores
    function filtragem_Servidores() {
        const filtro = document.getElementById("id_filter").value;
        const pesquisa = document.getElementById("id_pesquisa").value.toLowerCase();

        elServerList.innerHTML = "";

        if (["Nivel_c", "Critico_c", "Alerta_c"].includes(filtro)) {
            servers.sort((a, b) => Number(a.nivel) - Number(b.nivel));
        } else if (["Nivel_d", "Critico_d", "Alerta_d"].includes(filtro)) {
            servers.sort((a, b) => Number(b.nivel) - Number(a.nivel));
        }

        for (let i = 0; i < servers.length; i++) {
            const s = servers[i];
            const status = getRiskStatusFromLevel(s.nivel);

            const passouFiltroEstado =
                (filtro.startsWith("Critico") && status === "danger") ||
                (filtro.startsWith("Alerta") && status === "atention") ||
                (filtro === "Bom" && status === "ok") ||
                (filtro.startsWith("Nivel"));

            const recursosText = Array.isArray(s.recursos) ? s.recursos.join(", ") : String(s.recursos);
            const passouFiltroPesquisa =
                s.name.toLowerCase().includes(pesquisa) ||
                s.localizacao.toLowerCase().includes(pesquisa) ||
                recursosText.toLowerCase().includes(pesquisa);

            if (passouFiltroEstado && passouFiltroPesquisa) {
                gerar_server(i);
            }
        }
    }

    updateKPIs();
    filtragem_Servidores();
</script>