<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../css/dashboard/servers.css">
    <link rel="stylesheet" href="../../css/style.css">
    <script src="./script/dash.js"></script>
    <title>ARGUS | Servidores</title>
</head>


<body>
    <div id="id_sair">
    </div>

    <div id="modal" class="modal">
        <div class="modal-geral" id="div_modal_label"></div>
    </div>

    <header class="desktopNav" id="navDesktop"></header>

    <header class="headerTop">
        <div class="geralInfo">
            <div class="info tooltipInfo">
                <div class="server">
                    <img src="../../assets/dashboard/desktop/server.svg" alt="">
                </div>
                <div class="serversMonitoring" id="id_servidores_monitorados">
                </div>
                <span class="tooltiptextInfo">
                    Servidores em monitoramento
                </span>
            </div>
            <div class="info">
                <div class="bell">
                    <img src="../../assets/dashboard/desktop/bell.svg" alt="">
                </div>
                <div class="risk tooltipInfo" id="id_servidores_em_estado_critico">
                    <p id="qtd_critico">1</p>
                    <span class="tooltiptextInfo">
                        Servidores em atenção
                    </span>
                </div>
            </div>
        </div>
    </header>

    <div class="top-boxes-container">

        <div class="info-box alert-box">
            <p class="label">Alertas totais (24h)</p>
            <p class="value">5</p>
        </div>

        <div class="info-box server-box">
            <p class="label">Servidor com mais alertas (semana)</p>
            <p class="value">SERV1</p>
        </div>

        <div class="info-box component-box">
            <p class="label">Componente recorrente</p>
            <p class="value">RAM</p>
        </div>

    </div>

    <div class="search" id="search">
    </div>

    <div class="container">
        <div class="server-list" id="regioes"></div>
    </div>

    <div class="container-boxes-down">
        <div class="container-boxes-title">
            <p>Visão por componentes</p>
            <p class="boxes-subtitle">selecione um servidor</p>
        </div>

        <div class="container-boxes-comp">
            <div>
                <p>CPU</p>
                <div class="box-card">
                    <div>
                        <p class="label-box">Média (24h)</p>
                        <p class="value-box"  id="media_cpu">-</p>
                    </div>
                    <div>
                        <p class="label-box">Pico (1h)</p>
                        <p class="value-box"  id="pico_cpu">-</p>
                    </div>
                </div>
            </div>
            <div>
                <p>GPU</p>
                <div class="box-card">
                    <div>
                        <p class="label-box">Média (24h)</p>
                        <p class="value-box" id="media_gpu">-</p>
                    </div>
                    <div>
                        <p class="label-box">Pico (1h)</p>
                        <p class="value-box" id="pico_gpu">-</p>
                    </div>
                </div>
            </div>
            <div>
                <p>RAM</p>
                <div class="box-card">
                    <div>
                        <p class="label-box">Média (24h)</p>
                        <p class="value-box" id="media_ram">-</p>
                    </div>
                    <div>
                        <p class="label-box">Pico (1h)</p>
                        <p class="value-box" id="pico_ram">-</p>
                    </div>
                </div>
            </div>
            <div>
                <p>DISCO</p>
                <div class="box-card">
                    <div>
                        <p class="label-box">% Total (<span id="data_disco">XXXX-XX-XX</span>)</p>
                        <p class="value-box" id="media_disco">-</p>
                    </div>
                    <div>
                        <p class="label-box">Taxa de variação (1h)</p>
                        <p class="value-box" id="pico_disco">-</p>
                    </div>
                </div>
            </div>
            <div>
                <p>REDE</p>
                <div class="box-card">
                    <div>
                        <p class="label-box">Média (24h)</p>
                        <p class="value-box" id="media_rede">-</p>
                    </div>
                    <div>
                        <p class="label-box">Pico (1h)</p>
                        <p class="value-box" id="pico_rede">-</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    </div>
</body>


</html>
<script>
    header("server", sessionStorage.CARGO_CARGO);

    if(sessionStorage.CARGO_CARGO == "ROOT"){
        document.getElementById("search").innerHTML = '<button onclick="abrirModal()">Adicionar server</button>'
    }

    var nome = null;
    var nome_estado = null;
    var sigla_estado = null;

    function listarServidoresTotais() {
        let id = sessionStorage.EMPRESA_ID
        fetch(`/servidores/contarServidores/${id}`, {
            method: "GET",
            headers: { "Content-Type": "application/json" }
        })
            .then((resposta) => {
                resposta.json().then((json) => {
                    console.log(json)
                    elMonitored.innerHTML = json[0].totalServers
                })
            })
    }

    function botaoLimpar() {
        nome = ipt_nome.value;
        nome_estado = ipt_nome_estado.value;
        sigla_estado = ipt_sigla_estado.value;

        div_modal_label.innerHTML = `<h1>Limite Componentes</h1>
            <div class="modal-label" id="div_modal_label">
                <label for="ipt_nome_cpu">Limite CPU:</label>
                <div class="modal-label-comp">
                    <input type="number" name="" id="ipt_maxCPU" placeholder="Digite o limite máximo da CPU">
                    <input type="number" name="" id="ipt_minCPU" placeholder="Digite o mínimo da CPU">
                </div>
            </div>
            <div class="modal-label" id="div_modal_label">
                <label for="ipt_nome_ram">Limite RAM:</label>
                <div class="modal-label-comp">
                    <input type="number" name="" id="ipt_maxRAM" placeholder="Digite o limite máximo da RAM">
                    <input type="number" name="" id="ipt_minRAM" placeholder="Digite o mínimo da RAM">
                </div>
            </div>
            <div class="modal-label" id="div_modal_label">
                <label for="ipt_nome_disco">Limite DISCO:</label>
                <div class="modal-label-comp">
                    <input type="number" name="" id="ipt_maxDISCO" placeholder="Digite o limite máximo do DISCO">
                    <input type="number" name="" id="ipt_minDISCO" placeholder="Digite o mínimo do DISCO">
                    </div>
                </div>
            <div class="modal-label" id="div_modal_label">
                <label for="ipt_nome_rede">Limite REDE:</label>
                <div class="modal-label-comp">
                    <input type="number" name="" id="ipt_maxREDE" placeholder="Digite o limite máximo da REDE">
                    <input type="number" name="" id="ipt_minREDE" placeholder="Digite o mínimo da REDE">
                </div>
            </div>
            <div class="modal-label" id="div_modal_label">
                <label for="ipt_nome_gpu">Limite GPU:</label>
                <div class="modal-label-comp">
                    <input type="number" name="" id="ipt_maxGPU" placeholder="Digite o limite máximo da GPU">
                    <input type="number" name="" id="ipt_minGPU" placeholder="Digite o mínimo da GPU">
                </div>
            </div>
            <div class="modal-button">
                <div onclick="fecharModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                        <rect width="24" height="24" fill="none" />
                        <path fill="#fff"
                            d="M6.4 19L5 17.6l5.6-5.6L5 6.4L6.4 5l5.6 5.6L17.6 5L19 6.4L13.4 12l5.6 5.6l-1.4 1.4l-5.6-5.6z" />
                    </svg>
                </div>
                <div onclick="addServidor()" id="modal_prosseguir">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="24" viewBox="0 0 12 24">
                        <rect width="12" height="24" fill="none" />
                        <path fill="#fff" fill-rule="evenodd"
                            d="M10.157 12.711L4.5 18.368l-1.414-1.414l4.95-4.95l-4.95-4.95L4.5 5.64l5.657 5.657a1 1 0 0 1 0 1.414" />
                    </svg>
                </div>
            </div>`;
    };

    function abrirModal() {
        let modal = document.getElementById("modal")
        let conteudo = document.getElementById("div_modal_label")
        modal.style.display = "flex"

        conteudo.innerHTML = `
            <h1>Adicionar servidor</h1>
            <div class="modal-label">
                <label for="ipt_nome">Nome do Servidor:</label>
                <input type="text" name="" id="ipt_nome" placeholder="Digite o nome do servidor">

                <label for="ipt_nome_estado">Nome do Estado:</label>
                <input type="text" name="" id="ipt_nome_estado" placeholder="Digite o nome do estado">

                <label for="ipt_sigla_estado">Sigla do Servidor:</label>
                    <input type="text" name="" id="ipt_sigla_estado" maxlength="2" placeholder="Digite a sigla do estado">
            </div>
            <div class="modal-button">
            </div>
            <div class="modal-button">
            </div>
            <div class="modal-button">
                <div onclick="fecharModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                        <rect width="24" height="24" fill="none" />
                        <path fill="#fff"
                            d="M6.4 19L5 17.6l5.6-5.6L5 6.4L6.4 5l5.6 5.6L17.6 5L19 6.4L13.4 12l5.6 5.6l-1.4 1.4l-5.6-5.6z" />
                    </svg>
                </div>
                <div id="modal_prosseguir" onclick="botaoLimpar()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="24" viewBox="0 0 12 24">
                        <rect width="12" height="24" fill="none" />
                        <path fill="#fff" fill-rule="evenodd"
                            d="M10.157 12.711L4.5 18.368l-1.414-1.414l4.95-4.95l-4.95-4.95L4.5 5.64l5.657 5.657a1 1 0 0 1 0 1.414" />
                    </svg>
                </div>
            </div>`
    }

    function fecharModal() {
        let modal = document.getElementById("modal")
        modal.style.display = "none"
    }

    function addServidor() {

        const maxCPU = ipt_maxCPU.value;
        const minCPU = ipt_minCPU.value;
        const maxRAM = ipt_maxRAM.value;
        const minRAM = ipt_minRAM.value;
        const maxDISCO = ipt_maxDISCO.value;
        const minDISCO = ipt_minDISCO.value;
        const maxREDE = ipt_maxREDE.value;
        const minREDE = ipt_minREDE.value;
        const maxGPU = ipt_maxGPU.value;
        const minGPU = ipt_minGPU.value;

        function validarLimite(max, min, nome) {
            if (isNaN(max) || isNaN(min)) {
                alert(`Preencha corretamente os valores de ${nome}.`);
                return false;
            }
            if (max < min) {
                alert(`O valor máximo de ${nome} não pode ser menor que o mínimo.`);
                return false;
            }
            if (max > 100 || max < 1) {
                alert(`O valor máximo de ${nome} deve ser entre 1 e 100.`);
                return false;
            }
            if (min < 0) {
                alert(`O valor mínimo de ${nome} não pode ser menor que 0.`);
                return false;
            }
            if (min > max) {
                alert(`O valor mínimo de ${nome} não pode ser maior que o máximo.`);
                return false;
            }
            return true;
        }

        if (
            !validarLimite(maxCPU, minCPU, "CPU") ||
            !validarLimite(maxRAM, minRAM, "RAM") ||
            !validarLimite(maxDISCO, minDISCO, "DISCO") ||
            !validarLimite(maxREDE, minREDE, "REDE") ||
            !validarLimite(maxGPU, minGPU, "GPU")
        ) {
            return;
        }

        fetch("/servidores/addServidor", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                nomeServer: nome,
                empresaServer: sessionStorage.EMPRESA_ID,
                nomeEstadoServer: nome_estado,
                siglaEstadoServer: sigla_estado,
                maxCpuServer: maxCPU,
                minCpuServer: minCPU,
                maxRamServer: maxRAM,
                minRamServer: minRAM,
                maxDiscoServer: maxDISCO,
                minDiscoServer: minDISCO,
                maxRedeServer: maxREDE,
                minRedeServer: minREDE,
                maxGpuServer: maxGPU,
                minGpuServer: minGPU
            })
        })
            .then((resposta) => {
                if (resposta.ok) {
                    console.log("Cadastro realizado com sucesso")
                } else (
                    console.log("Erro ao cadastrar")
                )
            })
            .catch((erro) => console.error(`#ERRO: ${erro}`))
    }

    function listarEstados() {
        const id = sessionStorage.EMPRESA_ID;
        fetch(`/servidores/listar/${id}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then((resposta) => {
                resposta.json().then(json => {
                    console.log(json)
                    const regioes = document.getElementById("regioes")
                    for (let i = 0; i < json.length; i++) {
                        var qtdServer = json[i].total_servidores > 1 ? "Servidores" : "Servidor"

                        var risco;
                        if (i == 0) {
                            risco = "../../assets/dashboard/desktop/danger.svg"
                        } else {
                            risco = "../../assets/dashboard/desktop/ok.svg"
                        }
                        regioes.innerHTML += `<div class="slakk">
                            <div class="regioes-card" data-sigla="${json[i].sigla_estado}" onclick="listarServidores(this)">
                                <img src="${risco}"></img>
                                <p>${json[i].nome_estado} - ${json[i].sigla_estado} |
                                     ${json[i].total_servidores} ${qtdServer}</p>
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 15 15"><rect width="15" height="15" fill="none"/><path fill="#fff" d="M7.5 12L0 4h15z"/></svg>
                                </div>
                                <div class="server-list" id="id_server_list_${json[i].sigla_estado}">
                                </div>
                        </div>`
                    }
                })
            })
    }

    function listarServidores(objetoHTML) {
        const siglaObjeto = objetoHTML.dataset.sigla
        const id = sessionStorage.EMPRESA_ID
        const filhos = objetoHTML.children
        filhos[2].style.transform = "rotate(180deg)"
        const divServ = document.getElementById(`id_server_list_${siglaObjeto}`)
        divServ.innerHTML = ""
        objetoHTML.setAttribute('onclick', "fecharServidores(this)")

        fetch(`/servidores/listarServidores/${id}/${siglaObjeto}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(resposta => {
                resposta.json().then((json) => {
                    console.log(json)
                    json.forEach(servidor => {
                        if (servidor.nome == "serv1") {
                            var risco = "../../assets/dashboard/desktop/danger.svg"
                            divServ.innerHTML += `
                         <div class="server-object" onclick="selecionarServ(valoresMockados.Serv1)">
                            <div class="serverIcon tooltipInfo">
                                <img class="server-icon-status" src="${risco}" alt="Status do servidor">
                            </div>
                            <div class="serverName">${servidor.nome}</div>
                            <div class="serverLocation"><p>CPU, RAM, DISCO</p></div>
                        </div>
                        `
                        } else {
                            divServ.innerHTML += `
                         <div class="server-object">
                            <div class="serverIcon"></div>
                            <div class="serverName">${servidor.nome}</div>
                        </div>
                        `}
                    })
                })
            })

    }


    function fecharServidores(objetoHTML) {
        const siglaObjeto = objetoHTML.dataset.sigla
        const divServ = document.getElementById(`id_server_list_${siglaObjeto}`)
        divServ.innerHTML = ""
        const filhos = objetoHTML.children
        console.log(filhos)
        filhos[2].style.transform = "rotate(0deg)"

        objetoHTML.setAttribute('onclick', "listarServidores(this)")
    }

    const valoresMockados = {
        "Serv1" : {
            'cpu': ['67.2%', '82.5%'],
            'gpu': ['72.5%', '94.8%'],
            'ram': ['71.3%', '83.5%'],
            'disco': ['81.2%', '0.2%', '2025-10-27'],
            'rede': ['0.5ms', '1.2ms']
        }
    }

    const mediaCpu = document.getElementById("media_cpu")
    const mediaGPU = document.getElementById("media_gpu")
    const mediaRam = document.getElementById("media_ram")
    const mediaDisco = document.getElementById("media_disco")
    const mediaRede = document.getElementById("media_rede")
    const picoCpu = document.getElementById("pico_cpu")
    const picoGPU = document.getElementById("pico_gpu")
    const picoRam = document.getElementById("pico_ram")
    const picoDisco = document.getElementById("pico_disco")
    const picoRede = document.getElementById("pico_rede")
    const horaDisco = document.getElementById("data_disco")

    function selecionarServ(servidor){
        console.log(servidor)
        mediaCpu.innerHTML = servidor.cpu[0]
        picoCpu.innerHTML = servidor.cpu[1]

        mediaGPU.innerHTML = servidor.gpu[0]
        picoGPU.innerHTML = servidor.gpu[1]

        mediaRam.innerHTML = servidor.ram[0]
        picoRam.innerHTML = servidor.ram[1]

        mediaDisco.innerHTML = servidor.disco[0]
        picoDisco.innerHTML = servidor.disco[1]
        horaDisco.innerHTML = servidor.disco[2]
        
        mediaRede.innerHTML = servidor.rede[0]
        picoRede.innerHTML = servidor.rede[1]
    }



    const elMonitored = document.getElementById("id_servidores_monitorados");
    const elQtdCritico = document.getElementById("qtd_critico");
    const elQtdAlerta = document.getElementById("qtd_alerta");
    const elServerList = document.getElementById("id_server_list");

    // updateKPIs();
    // filtragem_Servidores();
    listarEstados()
    listarServidoresTotais();
</script>