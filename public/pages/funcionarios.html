<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../css/dashboard/funcionarios.css">
  <link rel="stylesheet" href="../css/dashboard/servers.css">
  <link rel="stylesheet" href="../css/style.css">
  <title>ARGUS | Funcionários</title>
</head>

<body>
  <div class="overlay" id="overlay">
    <div id="config_funcionarios" class="popup">
      <img src="../assets/dashboard/desktop/btnFechar.svg" alt="Fechar" class="btnFecharPopup" onclick="fechar_popup()">

    </div>
  </div>

  <div id="id_sair">
  </div>

  <header class="desktopNav">
    <div class="navButtons">
      <a href="perfil.html" class="navButton tooltipNav" id="navUser">
        <img src="../assets/fotoPerfil/padrao.svg" alt="" id="FotoNavBar">
        <span class="tooltiptextNav">
          <div id="userNome"></div>
          <div id="userCargo">ADM</div>
        </span>
      </a>
      <a href="../pages/servers.html" class="navButton tooltipNav" id="navServers">
        <img src="../assets/dashboard/desktop/box.svg" alt="Servidores">
        <span class="tooltiptextNav">Servidores</span>
      </a>

      <a href="../pages/funcionarios.html" class="navButton tooltipNav" id="navServers">
        <img class="selected" src="../assets/dashboard/desktop/employes.svg" alt="Funcionários">
        <span class="tooltiptextNav">Funcionários</span>
      </a>
      <div class="navButton tooltipNav" id="navServers">
        <img src="../assets/dashboard/desktop/logs.svg" alt="Logs">
        <span class="tooltiptextNav">Logs</span>
      </div>
      <a href="https://sptech-team-vbjwf7te.atlassian.net/servicedesk/customer/portal/36" class="navButton tooltipNav"
        id="navServers" target="_blank">
        <img src="../assets/dashboard/desktop/headphone.svg" alt="Suporte">
        <span class="tooltiptextNav">Suporte</span>
      </a>
      <div class="navButton tooltipNav" id="navServers" onclick="sair()">
        <img src="../assets/dashboard/desktop/logout.svg" alt="Sair">
        <span class="tooltiptextNav">Sair</span>
      </div>
    </div>
    <img class="logo" src="../assets/icon/logoBlack.svg" alt="">
  </header>
  <header class="headerTop">
    <div class="geralInfo">
      <div class="info tooltipInfo">
        <div class="server">
          <img src="../assets/dashboard/desktop/server.svg" alt="">
        </div>
        <div class="serversMonitoring" id="id_servidores_monitorados">
        </div>
        <span class="tooltiptextInfo">
          Servidores em monitoramento
        </span>
      </div>
      <div class="info">
        <div class="bell">
          <img src="../assets/dashboard/desktop/bell.svg" alt="">
        </div>
        <div class="risk tooltipInfo" id="id_servidores_em_estado_critico">
          <p id="qtd_critico"></p>
          <span class="tooltiptextInfo">
            Servidores em atenção
          </span>
        </div>
        <div class="atention tooltipInfo" id="id_servidores_em_estado_de_alerta">
          <p id="qtd_alerta"></p>
          <span class="tooltiptextInfo">
            Servidores em alerta
          </span>
        </div>
      </div>
    </div>

    <div id="editContainer" class="editContainer">
      <img class="iconLapis" src="../assets/funcionarios/lapis.svg" alt="" onclick="filtrarFuncionarios(true)">
      <span class="tooltiptextInfo">Editar </span>
    </div>
  </header>

  <div class="search">
    <select id="id_filter" onchange="filtrarFuncionarios()">
      <option value="" selected>Todos</option>
    </select>
    <input type="search" id="id_pesquisa" placeholder="Pesquisar funcionário" oninput="filtrarFuncionarios()">
  </div>
  <div class="containerFunc">
    <div class="funcInfo">
      <div class="funcFoto">
        Foto
      </div>
      <div class="funcName">
        Nome
      </div>
      <div class="funcEmail">
        Email
      </div>
      <div class="funcCargo">
        Cargo
      </div>
      <div class="dtCadastro">
        Data de Cadastro
      </div>
      <div class="functel">
        Telefone
      </div>
      <div id="funcStatusInfo" class="funcStatusInfo">
        Status
      </div>

    </div>
    <div class="func-list" id="id_func_list">

    </div>

  </div>
</body>

</html>

<script>
  let editar = false;
  let funcionariosLista;

  const container = document.getElementById("id_func_list");

  function listarCargo() {
    const select = document.getElementById("id_filter");

    fetch("/usuarios/listarCargo")
      .then(res => res.json())
      .then(cargos => {
        cargos.forEach(c => {
          const option = document.createElement("option");
          option.value = c.cargo;
          option.textContent = c.cargo;
          select.appendChild(option);
        });
      })
      .catch(err => console.error("Erro ao carregar cargos:", err));
  }


  window.onload = () => {
    listarCargo();
    fetch(`/usuarios/filtrar`).then(res => {
      if (res.ok) {
        res.json().then(resposta => {
          funcionariosLista = resposta;
          filtrarFuncionarios(editar);
        })
      }
    })//fim fetch
  };

  function filtrarFuncionarios(edit) {
    console.log(edit)
    const filtro = document.getElementById("id_filter").value.toLowerCase();
    const pesquisa = document.getElementById("id_pesquisa").value.toLowerCase();
    container.innerHTML = "";
    var contStatus = 0;

    if (!edit) {
      editar = false;
      funcStatusInfo.innerHTML = `Status`
      editContainer.innerHTML = `
                <img class="iconLapis" src="../assets/funcionarios/lapis.svg" alt="" onclick="filtrarFuncionarios(true)">
                <span class="tooltiptextInfo">Editar </span>
                `;
      for (let i = 0; i < funcionariosLista.length; i++) {
        const cargoIgual = filtro === "" || funcionariosLista[i].cargo.toLowerCase() === filtro;
        const pesquisaIgual =
          funcionariosLista[i].nome.toLowerCase().includes(pesquisa) ||
          funcionariosLista[i].email.toLowerCase().includes(pesquisa);

        if (funcionariosLista[i].sobrenome == null) {
          funcionariosLista[i].sobrenome = ""
        }

        if (cargoIgual && pesquisaIgual) {
          contStatus++;
          const statusIcon = `<img class="iconStatus" src="../assets/funcionarios/eyeClosed.svg" alt="Offline">`;
          container.innerHTML += `
                                    <div id="funcItem" class="funcionario-item" data-idFuncionario=${funcionariosLista[i].id}>
                                        <div class="funcFoto">
                                            <img src="../assets/fotoPerfil/${funcionariosLista[i].foto_perfil}" alt="Foto">
                                        </div>
                                        <div class="funcName">${funcionariosLista[i].nome} ${funcionariosLista[i].sobrenome}</div>
                                        <div class="funcEmail">${funcionariosLista[i].email}</div>
                                        <div class="funcCargo">${funcionariosLista[i].cargo}</div>
                                        <div class="dtCadastro">${funcionariosLista[i].data_cadastro}</div>
                                        <div class="functel">${funcionariosLista[i].telefone}</div>
                                        <div id="status${contStatus}"class="funcStatus">
                                            ${statusIcon}
                                        </div>
                                    </div>`;
        }
      }
    }
    else if (edit) {
      editar = true;

      editContainer.innerHTML = `
                <img class="iconLapis" src="../assets/funcionarios/salvarAlt.svg" alt="" onclick="filtrarFuncionarios(false)" >
                <span class="tooltiptextInfo">Salvar </span>`



      for (let i = 0; i < funcionariosLista.length; i++) {
        const cargoIgual = filtro === "" || funcionariosLista[i].cargo.toLowerCase() === filtro;
        const pesquisaIgual =
          funcionariosLista[i].nome.toLowerCase().includes(pesquisa) ||
          funcionariosLista[i].email.toLowerCase().includes(pesquisa);

        if (funcionariosLista[i].sobrenome == null) {
          funcionariosLista[i].sobrenome = ""
        }

        if (cargoIgual && pesquisaIgual) {
          var funcStatus = document.getElementById("funcStatusInfo")
          funcStatus.innerHTML = `<img  class= "buttons-edit" src="../assets/funcionarios/editGreen.svg" alt="" onclick="pop_up_adicionar()">`;

          container.innerHTML += `
                                    <div id="funcItem" class="funcionario-item" data-idFuncionario=${funcionariosLista[i].id}>
                                        <div class="funcFoto">
                                            <img src="../assets/fotoPerfil/${funcionariosLista[i].foto_perfil}" alt="Foto">
                                        </div>
                                        <div class="funcName">${funcionariosLista[i].nome} ${funcionariosLista[i].sobrenome}</div>
                                        <div class="funcEmail">${funcionariosLista[i].email}</div>
                                        <div class="funcCargo">${funcionariosLista[i].cargo}</div>
                                        <div class="dtCadastro">${funcionariosLista[i].data_cadastro}</div>
                                        <div class="functel">${funcionariosLista[i].telefone}</div>
                                        <div class="funcStatus">
                                            <img class= "buttons-edit" src="../assets/funcionarios/editYellow.svg" alt="Editar" onclick="pop_up_editar(${funcionariosLista[i].id})">
                                            <img class= "buttons-edit" src="../assets/funcionarios/iconDelete.svg" alt="Deletar" onclick="pop_up_excluir(${funcionariosLista[i].id})">
                                        </div>
                                    </div>`;
        }
      }
    }
  }
  function abrir_popup() {
    document.getElementById("overlay").style.display = "flex";
    document.body.classList.add("popup-open");
  }

  function fechar_popup() {
    document.getElementById("overlay").style.display = "none";
    document.body.classList.remove("popup-open");
    config_funcionarios.innerHTML = '';
  }

  function pop_up_adicionar() {
    abrir_popup();
    config_funcionarios.innerHTML = `
      <h1>Criar Usuário</h1>
      <div class="inputs">
        <div class="input-label-wrapper">
          <span class="input-label">Nome</span>
          <span class="obrigatorio">*obrigatório</span>
        </div>
        <input type="text" id="ipt_nome" required>

        <div class="input-label-wrapper">
          <span class="input-label">Sobrenome</span>
          <span class="obrigatorio">*obrigatório</span>
        </div>
        <input type="text" id="ipt_sobrenome" required>
        <div class="input-label-wrapper">
          <span class="input-label">Cargo</span>
          <span class="obrigatorio">*obrigatório</span>
        </div>
        <select id="ipt_cargo">
          <option value="">Selecione um cargo</option>
          <option value="1">Administrador</option>
          <option value="3">Analista</option>
          <option value="4">Operador</option>
        </select>
        <div class="input-label-wrapper">
          <span class="input-label">Email</span>
          <span class="obrigatorio">*obrigatório</span>
        </div>
        <input type="text" id="ipt_email" required>
        <div class="input-label-wrapper">
          <span class="input-label">Senha</span>
          <span class="obrigatorio">*obrigatório</span>
        </div>
        <input type="text" id="ipt_senha" required>
        <div class="input-label-wrapper">
          <span class="input-label">Confirmar senha</span>
          <span class="obrigatorio">*obrigatório</span>
        </div>
        <input type="text" id="ipt_confirmar_senha" required>
        <div class="input-label-wrapper">
          <span class="input-label">Telefone</span>
        </div>
        <input type="text" id="ipt_telefone" required>
      </div>
      <div id="mensagem_erro"></div>
      <div class="btns_popup">
        <button class="btn cadastrar" onclick="funcao_adicionar()">Cadastrar</button>
        <button class="btn fechar" onclick="fechar_popup()">Fechar</button>
      </div>
    `;
  }
  function funcao_adicionar() {
    var nomeVar = ipt_nome.value.trim();
    var sobrenomeVar = ipt_sobrenome.value.trim();
    var cargoVar = ipt_cargo.value;
    var emailVar = ipt_email.value.trim();
    var senhaVar = ipt_senha.value;
    var confirmacao_senhaVar = ipt_confirmar_senha.value;
    var telefoneVar = ipt_telefone.value.replace(/\D/g, "");
    var idEmpresaVar = sessionStorage.EMPRESA_ID;

    if (nomeVar === "") {
      marcarErro(ipt_nome, "O campo nome está em branco.");
      return;
    }
    if (sobrenomeVar === "") {
      marcarErro(ipt_sobrenome, "O campo sobrenome está em branco.");
      return;
    }
    if (cargoVar === "") {
      marcarErro(ipt_cargo, "O campo cargo está em branco.");
      return;
    }
    if (emailVar === "") {
      marcarErro(ipt_email, "O campo email está em branco.");
      return;
    }
    if (senhaVar === "") {
      marcarErro(ipt_nome, "O campo senha está em branco.");
      return;
    }
    if (confirmacao_senhaVar === "") {
      marcarErro(ipt_nome, "O campo confirmar senha está em branco.");
      return;
    }
    if (!/^\d{10,11}$/.test(telefoneVar)) {
      marcarErro(ipt_telefone, "Telefone deve ter 10 ou 11 números (com DDD)");
      return;
    }
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailVar)) {
      marcarErro(ipt_email, "Digite um e-mail válido");
      return;
    }
    if (senhaVar.length < 8 || !/[A-Za-z]/.test(senhaVar) || !/\d/.test(senhaVar)) {
      marcarErro(ipt_senha, "A senha deve ter pelo menos 8 caracteres, incluindo letras e números");
      return;
    }
    if (confirmacao_senhaVar !== senhaVar) {
      marcarErro(ipt_confirmar_senha, "As senhas não coincidem");
      return;
    }

    fetch("/usuarios/funcao_cadastrar", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        nomeServer: nomeVar,
        sobrenomeServer: sobrenomeVar,
        cargoServer: cargoVar,
        emailServer: emailVar,
        senhaServer: senhaVar,
        telefoneServer: telefoneVar,
        idEmpresaServer: idEmpresaVar
      }),
    })
      .then(resposta => {
        if (resposta.ok) {
          mostrarErro("Cadastro realizado com sucesso!");
          setTimeout(() => {
            window.location = "funcionarios.html";
          }, 2000);
        } else {
          throw "Houve um erro ao tentar realizar o cadastro!";
        }
      })
      .catch(erro => console.error(`#ERRO: ${erro}`));
  }



  function pop_up_editar(id) {
    abrir_popup()
    config_funcionarios.innerHTML = `
      <h1>Editar Usuário</h1>
      <div class="inputs">
        <div class="input-label-wrapper">
          <span class="input-label">Nome</span>
          <span class="obrigatorio">*obrigatório</span>
        </div>
        <input type="text" id="ipt_nome" required>

        <div class="input-label-wrapper">
          <span class="input-label">Sobrenome</span>
          <span class="obrigatorio">*obrigatório</span>
        </div>
        <input type="text" id="ipt_sobrenome" required>

        <div class="input-label-wrapper">
          <span class="input-label">Cargo</span>
          <span class="obrigatorio">*obrigatório</span>
        </div>
        <select id="ipt_cargo">
          <option value="">Selecione um cargo</option>
          <option value="1">Administrador</option>
          <option value="3">Analista</option>
          <option value="4">Operador</option>
        </select>

        <div class="input-label-wrapper">
          <span class="input-label">Email</span>
          <span class="obrigatorio">*obrigatório</span>
        </div>
        <input type="text" id="ipt_email" required>

        <div class="input-label-wrapper">
          <span class="input-label">Senha</span>
          <span class="obrigatorio">*obrigatório</span>
        </div>
        <input type="text" id="ipt_senha" required>

        <div class="input-label-wrapper">
          <span class="input-label">Confirmar senha</span>
          <span class="obrigatorio">*obrigatório</span>
        </div>
        <input type="text" id="ipt_confirmar_senha" required>

        <div class="input-label-wrapper">
          <span class="input-label">Telefone</span>
        </div>
        <input type="text" id="ipt_telefone" required>
        <div class="input-label-wrapper">
          <span class="input-label">Foto</span>
        </div>
        <input type="text" id="ipt_foto" required>
      </div>
      <div id="mensagem_erro"></div>
      <div class="btns_popup">
        <button class="btn cadastrar" onclick="funcao_editar(${id})">Editar</button>
        <button class="btn fechar" onclick="fechar_popup()">Fechar</button>
      </div>
        `;

  }
  function funcao_editar(idVar) {
    // Código para editar
  }

  function pop_up_excluir(id) {
    abrir_popup()
    config_funcionarios.innerHTML = `
    <h1>Deletar Usuário</h1>
    <div class="inputs">
      <p>Deseja deletar este usuário?</p>
    </div>
    <div id="mensagem_erro"></div>
    <div class="btns_popup">
      <button class="btn cadastrar" onclick="funcao_excluir(${id})">Sim</button>
      <button class="btn fechar" onclick="fechar_popup()">Não</button>
    </div>
        `;
    mensagem_erro.style.display = 'none';
  }
  function funcao_excluir(idVar) {
    fetch("/usuarios/funcao_excluir", {
      method: 'DELETE',
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        idServer: idVar

      })
    })
      .then(res => {
        if (res.ok) {
          mostrarErro("Funcionário deletado com sucesso!")

        } else {
          mostrarErro("Erro ao deletar Funcionário!")
        }
      })
      .catch(err => {
        console.error('Erro na requisição:', err);
      });//fim fetch
  }

  function mostrarErro(msg) {
    mensagem_erro.innerHTML = msg;
    setTimeout(() => {
      mensagem_erro.innerHTML = "";
      fechar_popup();
      window.location.reload()
    }, 5000);
  }

  function marcarErro(input, msg) {
    input.classList.add("erroInput");
    mostrarErro(msg);

    input.scrollIntoView({ behavior: "smooth", block: "center" });

    setTimeout(() => {
      input.classList.remove("erroInput");
    }, 2500);
  }



  function sair() {
    abrir_popup();
    config_funcionarios.innerHTML = `
                <h1>Deseja sair?</h1>
                <button onclick="sair_s()">Sim</button>
                <button onclick="sair_n()">Não</button>
        `;
  }
  function sair_s() {
    window.location.href = "./login.html";
    sessionStorage.clear;
  }

  function sair_n() {
    fechar_popup()
  }
  userNome.innerHTML = sessionStorage.USER_NAME;
  userCargo.innerHTML = sessionStorage.CARGO_CARGO;



</script>