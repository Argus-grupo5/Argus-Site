<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scnp=1.0">
    <title>Cadastro</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/login-cadastro/signin.css">
</head>

<body>
    <header class="desktopHeader">
        <a href="../index.html" class="logo"><img src="../assets/icon/logoBranca.svg" alt=""></a>
        <a href="../index.html" class="title">
            <h1>ARGUS</h1>
        </a>
        <nav class="links">
            <a class="link" href="../pages/empresa.html">Empresa</a>
            <a class="link" href="../pages/contato.html">Contato</a>
        </nav>
        <nav class="login">
            <a class="link" href="../pages/login.html">Entrar</a>
            <a class="buttons" href="../pages/signin.html">Cadastre-se</a>
        </nav>
    </header>
    <div class="bannerDesktop"></div>

    <div class="containerDesktop">
        <div class="heroPage">
            <h1>Cadastre sua empresa na Argus</h1>
            <div id="inputs" class="inputs">
                <section class="input">
                    <p>CEP</p>
                    <input maxlength="9" type="text" id="ipt_cep" onblur="buscarCep()" placeholder="00000-000">
                </section>
                <section class="input">
                    <p>Rua</p>
                    <input type="text" id="ipt_rua" placeholder="Rua">
                </section>
                <section class="input">
                    <p>Bairro</p>
                    <input type="text" id="ipt_bairro" placeholder="Bairro">
                </section>
                <section class="input">
                    <p>Cidade</p>
                    <input type="text" id="ipt_cidade" placeholder="Cidade">
                </section>
                <section class="input">
                    <p>Estado</p>
                    <input type="text" id="ipt_estado" placeholder="Estado">
                </section>
                <section class="input">
                    <p>Número</p>
                    <input type="number" id="ipt_numero" placeholder="1234">
                </section>
                <section class="input">
                    <p>Complemento</p>
                    <input type="text" id="ipt_complemento" placeholder="3° andar">
                </section>
            </div>

            <div id="mensagem_erro"></div>
            <section class="btnImagem" id="botaoAlteravel">
                <button class="btnImage" onclick="cadastrarEndereco()">
                    <img src="../assets/login-signin/Buttom.svg" alt="Botão para cadastro">
                </button>
            </section>
            <p>Já tem uma conta? <a href="login.html">Entre na Argus.</a></p>

            <div class="vetor"></div>
        </div>



        <div class="footer">
            <div class="links">
                <a href="">EULA</a>
                <a href="./empresa.html">Sobre Nós</a>
                <a href="./contato.html">Contato</a>
            </div>
            <p>© 2025 Argus Corporation. Ltd. All rights reserved.</p>
        </div>
    </div>
</body>

</html>
<script>
    var fotoVar;
    // Maiscara para o CEP
    document.getElementById("ipt_cep").addEventListener("input", function (e) {
        let value = e.target.value.replace(/\D/g, "");
        if (value.length > 5) {
            value = value.replace(/^(\d{5})(\d)/, "$1-$2");
        }
        e.target.value = value;
    });

    function mostrarErro(msg) {
        mensagem_erro.style.display = "block";
        mensagem_erro.innerHTML = msg;
        setTimeout(() => {
            mensagem_erro.style.display = "none";
        }, 5000);
    }

    function marcarErro(input, msg) {
        input.classList.add("erroInput");
        mostrarErro(msg);

        input.scrollIntoView({ behavior: "smooth", block: "center" });

        setTimeout(() => {
            input.classList.remove("erroInput");
        }, 2500);
    }


    function cadastrarEndereco() {
        let cepVar = ipt_cep.value;
        let ruaVar = ipt_rua.value.trim();
        let bairroVar = ipt_bairro.value.trim();
        let cidadeVar = ipt_cidade.value.trim();
        let estadoVar = ipt_estado.value.trim();
        let numeroVar = ipt_numero.value.trim();
        let complementoVar = ipt_complemento.value.trim();

        if (cepVar === "" || cepVar.replace(/\D/g, "").length !== 8) {
            marcarErro(ipt_cep, "Digite um CEP válido (8 números)");
            return;
        }
        if (ruaVar === "") {
            marcarErro(ipt_rua, "A rua está em branco");
            return;
        }
        if (bairroVar === "") {
            marcarErro(ipt_bairro, "O bairro está em branco");
            return;
        }
        if (cidadeVar === "") {
            marcarErro(ipt_cidade, "A cidade está em branco");
            return;
        }
        if (estadoVar === "") {
            marcarErro(ipt_estado, "O estado está em branco");
            return;
        }
        if (numeroVar === "" || Number(numeroVar) <= 0) {
            marcarErro(ipt_numero, "Digite um número válido");
            return;
        }
        if (complementoVar === "") {
            complementoVar = "Sem complemento";
        }

        inputs.innerHTML = `            
        <section class="input">
            <p>Nome Fantasia</p>
            <input type="text" id="ipt_nome" placeholder="Nome">
        </section>
        <section class="input">
            <p>Razão social</p>
            <input type="text" id="ipt_razao" placeholder="Razão social">
        </section>
        <section class="input">
            <p>CNPJ</p>
            <input type="text" id="ipt_cnpj" maxlength="18" placeholder="00.000.000/0000-00">
        </section> 
        <section class="input">
            <p>Telefone</p>
            <input maxlength="15" type="text" id="ipt_telefone" placeholder="(11) 98888-7777">
        </section>
        <section class="input">
            <p>Foto Perfil</p>
            <input nome="ipt_foto" type="file" id="ipt_foto">
        </section>
    `;
        // Adicionar foto nas pastas
        ipt_foto.addEventListener("change", () => {
            fotoVar = ipt_foto.files[0];
            console.log(fotoVar)
        });

        // Máscara para telefone e CNPJ
        document.getElementById("ipt_telefone").addEventListener("input", function (e) {
            let value = e.target.value.replace(/\D/g, "");

            if (value.length > 0) {
                value = value.replace(/^(\d{2})(\d)/g, "($1) $2");
            }
            if (value.length >= 10) {
                value = value.replace(/(\d{5})(\d{4})$/, "$1-$2");
            } else {
                value = value.replace(/(\d{4})(\d{4})$/, "$1-$2");
            }

            e.target.value = value;
        });

        document.getElementById("ipt_cnpj").addEventListener("input", function (e) {
            let value = e.target.value.replace(/\D/g, "");
            if (value.length > 2) {
                value = value.replace(/^(\d{2})(\d)/, "$1.$2");
            }
            if (value.length > 5) {
                value = value.replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3");
            }
            if (value.length > 8) {
                value = value.replace(/\.(\d{3})(\d)/, ".$1/$2");
            }
            if (value.length > 12) {
                value = value.replace(/(\d{4})(\d)/, "$1-$2");
            }

            e.target.value = value;
        });
        const caixa = document.getElementById("inputs");
        caixa.scrollTop = 0;
        botaoAlteravel.innerHTML = `
        <button class="btnImage" onclick="cadastrar('${cepVar}', '${ruaVar}', '${bairroVar}', '${cidadeVar}', '${estadoVar}', '${numeroVar}', '${complementoVar}')">
            <img src="../assets/login-signin/Buttom.svg" alt="Botão para cadastro">
        </button>
    `;
    }

    function cadastrar(cepVar, ruaVar, bairroVar, cidadeVar, estadoVar, numeroVar, complementoVar) {
        var nomeVar = ipt_nome.value.trim();
        var telefoneVar = ipt_telefone.value
        var razaoVar = ipt_razao.value.trim();
        var cnpjVar = ipt_cnpj.value;


        if (nomeVar.length < 3) {
            marcarErro(ipt_nome, "Nome Fantasia muito curto");
            return;
        }
        if (razaoVar.length < 3) {
            marcarErro(ipt_razao, "Razão Social inválida");
            return;
        }
        if (cnpjVar.length != 18) {
            marcarErro(ipt_cnpj, "CNPJ deve ter exatamente 14 números");
            return;
        }
        if (telefoneVar.length != 15) {
            marcarErro(ipt_telefone, "Telefone deve ter 11 números (com DDD)");
            return;
        }

        const formData = new FormData();
        formData.append("fotoServer", fotoVar);
        formData.append("nomeServer", nomeVar);
        formData.append("telefoneServer", telefoneVar);
        formData.append("cnpjServer", cnpjVar);
        formData.append("razaoServer", razaoVar);


        // Enviar endereço
        fetch("/usuarios/cadastrarEndereco", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                cepServer: cepVar,
                ruaServer: ruaVar,
                bairroServer: bairroVar,
                cidadeServer: cidadeVar,
                estadoServer: estadoVar,
                numeroServer: numeroVar,
                complementoServer: complementoVar
            }),
        })
            .then(resposta => {
                if (resposta.ok) return resposta.json();
                throw "Houve um erro ao tentar realizar o cadastro!";
            })
            .then(data => {
                let idVar = Number(data.insertId);
                formData.append("idServer", idVar);
                return fetch("/usuarios/cadastrarEmpresa", {
                    method: "POST",
                    body: formData
                });
            })
            .then(resposta => {
                if (resposta.ok) {
                    mostrarErro("Cadastro realizado com sucesso!");
                    setTimeout(() => {
                        window.location = "./login.html";
                    }, 2000);
                } else {
                    throw "Houve um erro ao tentar realizar o cadastro!";
                }
            })
            .catch(erro => console.error(`#ERRO: ${erro}`));

        return false;
    }

    async function buscarCep() {
        let cep = ipt_cep.value.replace(/\D/g, "");

        if (cep.length !== 8) {
            marcarErro(ipt_cep, "CEP inválido. Digite 8 números.");
            return;
        }

        const url = `https://viacep.com.br/ws/${cep}/json/`;
        try {
            const response = await fetch(url);
            const data = await response.json();

            if (data.erro) {
                marcarErro(ipt_cep, "CEP não encontrado!");
                return;
            }

            ipt_rua.value = data.logradouro || "";
            ipt_bairro.value = data.bairro || "";
            ipt_cidade.value = data.localidade || "";
            ipt_estado.value = data.uf || "";

            ipt_numero.focus();
        } catch (error) {
            console.error("Erro ao buscar CEP:", error);
            marcarErro(ipt_cep, "Ocorreu um erro ao buscar o CEP.");
        }
    }


</script>